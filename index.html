<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plug2Plug POS ‚Äî Single File</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    body{background:#0b1220;color:#fff}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:12px}
    .btn{border-radius:10px;padding:.6rem 1rem}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .field{background:#0f172a;border:1px solid #334155;border-radius:8px;padding:.5rem .75rem;color:#e5e7eb}
    .table-wrap{overflow:auto;max-height:360px}
    .chip{border:1px solid #475569;border-radius:999px;padding:.2rem .6rem;font-size:.75rem}
    .tab-btn.active{border-bottom:2px solid #60a5fa;color:#60a5fa}
  </style>
</head>
<body class="min-h-screen">
<div class="max-w-7xl mx-auto p-4 md:p-8">

  <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-6">
    <div>
      <h1 class="text-3xl font-bold">üè™ Plug2Plug POS</h1>
      <p class="text-slate-300">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠/‡∏Ç‡∏≤‡∏¢ ‚Ä¢ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Ä¢ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF ‚Ä¢ Sync Google Sheets</p>
    </div>
    <div class="flex gap-2 items-center">
      <input id="scriptUrl" type="url" placeholder="‡∏ß‡∏≤‡∏á Google Apps Script Web App URL (/exec)" class="field w-80" />
      <button id="setupBtn" class="btn bg-blue-600 hover:bg-blue-500">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
      <button id="loadBtn" class="btn bg-emerald-600 hover:bg-emerald-500">üì• ‡πÇ‡∏´‡∏•‡∏î</button>
      <button id="syncBtn" class="btn bg-purple-600 hover:bg-purple-500">üìä Sync</button>
    </div>
  </div>
  <div id="syncStatus" class="text-sm text-sky-300 mb-6">‡∏û‡∏£‡πâ‡∏≠‡∏°</div>

  <div class="flex gap-4 border-b border-slate-700 mb-4">
    <button class="tab-btn pb-2 active" data-tab="buy">üõí ‡∏ã‡∏∑‡πâ‡∏≠</button>
    <button class="tab-btn pb-2" data-tab="sell">üí∞ ‡∏Ç‡∏≤‡∏¢</button>
    <button class="tab-btn pb-2" data-tab="products">üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    <button class="tab-btn pb-2" data-tab="summary">üìä ‡∏™‡∏£‡∏∏‡∏õ</button>
    <button class="tab-btn pb-2" data-tab="reports">üìÑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
  </div>

  <!-- BUY -->
  <div id="buy" class="tabpane">
    <div class="card p-4 mb-4">
      <h2 class="text-xl font-semibold mb-3">üõí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</h2>
      <div class="grid md:grid-cols-3 gap-3 mb-3">
        <div>
          <label class="text-sm text-slate-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input id="buyDate" type="date" class="field w-full"/>
        </div>
        <div>
          <label class="text-sm text-slate-300">‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
          <div class="flex gap-2">
            <select id="buyStore" class="field w-full"></select>
            <button id="addStoreBtn" class="btn bg-emerald-700">+ ‡∏£‡πâ‡∏≤‡∏ô</button>
          </div>
        </div>
        <div class="flex items-end">
          <button id="addBuyItem" class="btn bg-sky-600">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>
      </div>

      <datalist id="productDatalist"></datalist>
      <div id="buyItems" class="space-y-2"></div>

      <div class="flex justify-end gap-2 mt-4">
        <button id="buyResetBtn" class="btn bg-slate-600">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</button>
        <button id="buySubmitBtn" class="btn bg-white text-black">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</button>
      </div>
      <div class="text-xs text-slate-400 mt-2">
        ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á ‚Äú‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ Autofill ‡∏£‡∏≤‡∏Ñ‡∏≤ ‚Äú‡∏ã‡∏∑‡πâ‡∏≠‚Äù
      </div>
    </div>
  </div>

  <!-- SELL -->
  <div id="sell" class="tabpane hidden">
    <div class="card p-4 mb-4">
      <h2 class="text-xl font-semibold mb-3">üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>
      <div class="grid md:grid-cols-3 gap-3 mb-3">
        <div>
          <label class="text-sm text-slate-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input id="sellDate" type="date" class="field w-full"/>
        </div>
        <div>
          <label class="text-sm text-slate-300">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
          <div class="flex gap-2">
            <select id="sellCustomer" class="field w-full"></select>
            <button id="addCustomerBtn" class="btn bg-emerald-700">+ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
          </div>
        </div>
        <div class="flex items-end">
          <button id="addSellItem" class="btn bg-sky-600">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>
      </div>

      <div id="sellItems" class="space-y-2"></div>

      <div class="flex justify-end gap-2 mt-4">
        <button id="sellResetBtn" class="btn bg-slate-600">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</button>
        <button id="sellSubmitBtn" class="btn bg-white text-black">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
      </div>
      <div class="text-xs text-slate-400 mt-2">
        ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á ‚Äú‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ Autofill ‡∏£‡∏≤‡∏Ñ‡∏≤ ‚Äú‡∏Ç‡∏≤‡∏¢‚Äù
      </div>
    </div>
  </div>

  <!-- PRODUCTS -->
  <div id="products" class="tabpane hidden">
    <div class="card p-4 mb-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
        <button id="addProductBtn" class="btn bg-sky-600">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </div>

      <div id="productForm" class="hidden card p-4 mb-3">
        <h3 class="font-semibold mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
        <div class="grid md:grid-cols-5 gap-3">
          <input id="productName" class="field" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"/>
          <select id="productCategory" class="field">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
          </select>
          <input id="productBuyPrice" class="field" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠" type="number" step="0.01" min="0"/>
          <input id="productSellPrice" class="field" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢" type="number" step="0.01" min="0"/>
          <label class="flex items-center gap-2"><input id="productHasVat" type="checkbox"/> <span>VAT 7%</span></label>
        </div>
        <div class="flex gap-2 mt-3">
          <button id="saveProductBtn" class="btn bg-emerald-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
          <button id="cancelProductBtn" class="btn bg-slate-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button id="addCategoryBtn" class="btn bg-purple-700">+ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</button>
        </div>
      </div>

      <div class="table-wrap">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-slate-300">
              <th class="p-2">‡∏ä‡∏∑‡πà‡∏≠</th><th class="p-2">‡∏´‡∏°‡∏ß‡∏î</th><th class="p-2">‡∏ã‡∏∑‡πâ‡∏≠</th><th class="p-2">‡∏Ç‡∏≤‡∏¢</th><th class="p-2">VAT</th><th class="p-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="productsTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- SUMMARY -->
  <div id="summary" class="tabpane hidden">
    <div class="card p-4 mb-4">
      <h2 class="text-xl font-semibold mb-3">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
      <div class="grid md:grid-cols-4 gap-3 mb-4">
        <div>
          <label class="text-sm text-slate-300">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
          <input id="sumMonth" type="month" class="field w-full"/>
        </div>
        <div>
          <label class="text-sm text-slate-300">‡πÇ‡∏´‡∏°‡∏î</label>
          <select id="sumMode" class="field w-full">
            <option value="buy">‡∏ã‡∏∑‡πâ‡∏≠</option>
            <option value="sell">‡∏Ç‡∏≤‡∏¢</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-slate-300">‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå PDF</label>
          <select id="pdfFilter" class="field w-full">
            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="actor">‡∏ï‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>
            <option value="category">‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
            <option value="vat">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ VAT</option>
          </select>
        </div>
        <div id="actorSelectBox" class="hidden">
          <label class="text-sm text-slate-300">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
          <select id="actorSelect" class="field w-full"><option value="__ALL__">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
        </div>
      </div>

      <div class="grid md:grid-cols-4 gap-3 mb-4">
        <div class="card p-3 text-center">
          <div class="text-sky-400 text-2xl" id="sumTotalQty">0</div><div class="text-sm text-slate-300">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°</div>
        </div>
        <div class="card p-3 text-center">
          <div class="text-emerald-400 text-2xl" id="sumTotalAmt">‡∏ø0</div><div class="text-sm text-slate-300">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</div>
        </div>
        <div class="card p-3 text-center">
          <div class="text-orange-400 text-2xl" id="sumVatAmt">‡∏ø0</div><div class="text-sm text-slate-300">VAT ‡∏£‡∏ß‡∏°</div>
        </div>
        <div class="card p-3 text-center">
          <div class="text-fuchsia-400 text-2xl" id="sumProfit">‡∏ø0</div><div class="text-sm text-slate-300">‡∏Å‡∏≥‡πÑ‡∏£ (‡∏Ç‡∏≤‡∏¢-‡∏ã‡∏∑‡πâ‡∏≠)</div>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-3">
        <div class="card p-3">
          <h3 class="font-semibold mb-2">‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
          <div class="table-wrap"><table class="w-full text-sm"><thead><tr><th class="p-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="p-1">‡∏´‡∏°‡∏ß‡∏î</th><th class="p-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="p-1">‡∏¢‡∏≠‡∏î</th></tr></thead><tbody id="sumByProduct"></tbody></table></div>
        </div>
        <div class="card p-3">
          <h3 class="font-semibold mb-2">‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
          <div class="table-wrap"><table class="w-full text-sm"><thead><tr><th class="p-1">‡∏´‡∏°‡∏ß‡∏î</th><th class="p-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="p-1">‡∏¢‡∏≠‡∏î</th></tr></thead><tbody id="sumByCategory"></tbody></table></div>
        </div>
        <div class="card p-3">
          <h3 class="font-semibold mb-2"><span id="actorTitle">‡∏ï‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô</span></h3>
          <div class="table-wrap"><table class="w-full text-sm"><thead><tr><th class="p-1"><span id="actorCol">‡∏£‡πâ‡∏≤‡∏ô</span></th><th class="p-1">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th></tr></thead><tbody id="sumByActor"></tbody></table></div>
        </div>
      </div>

      <div class="flex justify-between items-center mt-4">
        <div class="text-xs text-slate-400">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
        <div class="flex gap-2">
          <button id="exportCustomPdf" class="btn bg-red-600">üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF (‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî ‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå)</button>
          <button id="exportServerPdf" class="btn bg-orange-600">‚òÅÔ∏è PDF (‡∏à‡∏≤‡∏Å Apps Script)</button>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-3 mt-3">
        <div class="card p-3">
          <h4 class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</h4>
          <div class="table-wrap">
            <table class="w-full text-sm">
              <thead><tr><th class="p-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-2">‡∏£‡πâ‡∏≤‡∏ô</th><th class="p-2">‡∏¢‡∏≠‡∏î</th><th class="p-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
              <tbody id="buyHistory"></tbody>
            </table>
          </div>
        </div>
        <div class="card p-3">
          <h4 class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h4>
          <div class="table-wrap">
            <table class="w-full text-sm">
              <thead><tr><th class="p-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-2">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th class="p-2">‡∏¢‡∏≠‡∏î</th><th class="p-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
              <tbody id="sellHistory"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- REPORTS -->
  <div id="reports" class="tabpane hidden">
    <div class="card p-4">
      <h2 class="text-xl font-semibold mb-3">üìÑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Apps Script)</h2>
      <div class="grid md:grid-cols-3 gap-3">
        <div>
          <label class="text-sm text-slate-300">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
          <input id="reportMonth" type="month" class="field w-full"/>
        </div>
        <div class="flex items-end">
          <button id="generateServerPDF" class="btn bg-red-600">‡∏™‡∏£‡πâ‡∏≤‡∏á PDF 3 ‡∏´‡∏ô‡πâ‡∏≤</button>
        </div>
      </div>
      <div class="text-xs text-slate-400 mt-2">‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå <span class="chip">POS_Monthly_Reports</span> ‡πÉ‡∏ô Google Drive</div>
    </div>
  </div>
</div>

<script>
/* ------------------ State ------------------ */
let products = JSON.parse(localStorage.getItem('products')||'[]');
let stores = JSON.parse(localStorage.getItem('stores')||'["‡πÄ‡∏ã‡πÄ‡∏ß‡πà‡∏ô","‡πÇ‡∏•‡∏ï‡∏±‡∏™","‡∏ö‡∏¥‡πä‡∏Å‡∏ã‡∏µ","‡πÅ‡∏°‡πá‡∏Ñ‡πÇ‡∏Ñ‡∏£"]');
let customers = JSON.parse(localStorage.getItem('customers')||'["‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"]');
let categories = JSON.parse(localStorage.getItem('categories')||'["‡∏≠‡∏≤‡∏´‡∏≤‡∏£","‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°","‡∏Ç‡∏ô‡∏°","‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"]');
let buyTransactions = JSON.parse(localStorage.getItem('buyTransactions')||'[]');
let sellTransactions = JSON.parse(localStorage.getItem('sellTransactions')||'[]');

const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];

function saveToStorage(){
  localStorage.setItem('products', JSON.stringify(products));
  localStorage.setItem('stores', JSON.stringify(stores));
  localStorage.setItem('customers', JSON.stringify(customers));
  localStorage.setItem('categories', JSON.stringify(categories));
  localStorage.setItem('buyTransactions', JSON.stringify(buyTransactions));
  localStorage.setItem('sellTransactions', JSON.stringify(sellTransactions));
}
function uid(prefix=''){ return prefix + Math.random().toString(36).slice(2,8) + Date.now().toString(36).slice(-4); }
function toISODateClient(v){
  if(!v) return '';
  if (v instanceof Date) return v.toISOString().slice(0,10);
  const s=String(v).trim();
  const m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
  if (m) return `${m[1]}-${String(m[2]).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`;
  const d=new Date(s.replace(/\//g,'-'));
  if(!isNaN(d)) return d.toISOString().slice(0,10);
  return s;
}
function monthKeyFromDate(v){ const iso=toISODateClient(v); return (iso && iso.length>=7) ? iso.slice(0,7) : ''; }
function thb(n){ return new Intl.NumberFormat('th-TH',{style:'currency',currency:'THB'}).format(Number(n)||0); }

/* ------------------ Tabs ------------------ */
$$('.tab-btn').forEach(btn=>{
  btn.onclick=()=>{
    $$('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const id=btn.dataset.tab;
    $$('.tabpane').forEach(p=>p.classList.add('hidden'));
    $('#'+id).classList.remove('hidden');
    if(id==='summary'){ renderSummary(); }
    if(id==='reports'){ const now=new Date(); $('#reportMonth').value = now.toISOString().slice(0,7); }
  };
});

/* ------------------ Script URL + Status ------------------ */
const syncStatus = $('#syncStatus');
function setSyncStatus(msg,cls='text-sky-300'){ syncStatus.textContent=msg; syncStatus.className=cls; }
function getScriptUrl(){ return $('#scriptUrl').value.trim(); }
function rememberScriptUrl(){ localStorage.setItem('scriptUrl', getScriptUrl()); }
(function restoreScriptUrl(){ const u=localStorage.getItem('scriptUrl'); if(u) $('#scriptUrl').value=u; })();

/* ------------------ Init Defaults ------------------ */
$('#buyDate').value = toISODateClient(new Date());
$('#sellDate').value = toISODateClient(new Date());

function refreshStoreCustomer(){
  $('#buyStore').innerHTML = stores.map(s=>`<option value="${s}">${s}</option>`).join('');
  $('#sellCustomer').innerHTML = customers.map(c=>`<option value="${c}">${c}</option>`).join('');
}
function refreshCategories(){
  $('#productCategory').innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>` + categories.map(c=>`<option>${c}</option>`).join('');
}
function refreshProductTable(){
  const tb = $('#productsTable');
  if(!products.length){ tb.innerHTML = `<tr><td colspan="6" class="p-3 text-center text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>`; return; }
  tb.innerHTML = products.map(p=>`
    <tr class="border-b border-slate-700">
      <td class="p-2">${p.name}</td>
      <td class="p-2">${p.category||'-'}</td>
      <td class="p-2">${thb(p.buyPrice||0)}</td>
      <td class="p-2">${thb(p.sellPrice||0)}</td>
      <td class="p-2"><span class="chip">${p.hasVat?'VAT 7%':'‡πÑ‡∏°‡πà VAT'}</span></td>
      <td class="p-2">
        <button class="text-amber-300" onclick="editProduct('${p.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <span class="mx-2 text-slate-600">|</span>
        <button class="text-rose-300" onclick="deleteProduct('${p.id}')">‡∏•‡∏ö</button>
      </td>
    </tr>
  `).join('');
  refreshProductDatalist();
}
function refreshProductDatalist(){ $('#productDatalist').innerHTML = products.map(p=>`<option value="${p.name}"></option>`).join(''); }

/* ------------------ Product CRUD ------------------ */
let editingProductId = null;
$('#addProductBtn').onclick=()=>{ $('#productForm').classList.remove('hidden'); editingProductId=null; $('#productName').value=''; $('#productCategory').value=''; $('#productBuyPrice').value=''; $('#productSellPrice').value=''; $('#productHasVat').checked=false; };
$('#cancelProductBtn').onclick=()=>{ $('#productForm').classList.add('hidden'); };
$('#addCategoryBtn').onclick=()=>{ const name=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà:'); if(name && !categories.includes(name)){ categories.push(name); saveToStorage(); refreshCategories(); } };
function editProduct(id){
  const p=products.find(x=>x.id===id); if(!p) return;
  $('#productForm').classList.remove('hidden');
  editingProductId=id;
  $('#productName').value=p.name;
  $('#productCategory').value=p.category||'';
  $('#productBuyPrice').value=p.buyPrice||0;
  $('#productSellPrice').value=p.sellPrice||0;
  $('#productHasVat').checked=!!p.hasVat;
}
function deleteProduct(id){
  if(!confirm('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?')) return;
  products = products.filter(p=>p.id!==id);
  saveToStorage(); refreshProductTable();
}
$('#saveProductBtn').onclick=()=>{
  const name=$('#productName').value.trim();
  const category=$('#productCategory').value.trim();
  const buyPrice=Number($('#productBuyPrice').value||0);
  const sellPrice=Number($('#productSellPrice').value||0);
  const hasVat=$('#productHasVat').checked;
  if(!name) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
  if(editingProductId){
    const p=products.find(x=>x.id===editingProductId);
    Object.assign(p,{name,category,buyPrice,sellPrice,hasVat});
  }else{
    products.push({id:uid('p_'),name,category,buyPrice,sellPrice,hasVat});
  }
  saveToStorage(); refreshProductTable(); $('#productForm').classList.add('hidden'); refreshProductDatalist();
};

/* ------------------ Add Store/Customer ------------------ */
$('#addStoreBtn').onclick=()=>{ const s=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô:'); if(s && !stores.includes(s)){ stores.push(s); saveToStorage(); refreshStoreCustomer(); } };
$('#addCustomerBtn').onclick=()=>{ const c=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:'); if(c && !customers.includes(c)){ customers.push(c); saveToStorage(); refreshStoreCustomer(); } };

/* ------------------ Item Rows (Buy/Sell) ------------------ */
function makeItemRow(mode){
  const wrap = document.createElement('div');
  wrap.className='card p-3';
  wrap.innerHTML=`
    <div class="grid md:grid-cols-4 gap-2 items-end">
      <div>
        <label class="text-xs text-slate-400">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
        <input class="field w-full product-name" list="productDatalist" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"/>
      </div>
      <div>
        <label class="text-xs text-slate-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
        <input class="field w-full qty" type="number" min="1" value="1"/>
      </div>
      <div>
        <label class="text-xs text-slate-400">${mode==='buy'?'‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ø)':'‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ø)'}</label>
        <input class="field w-full price" type="number" min="0" step="0.01" />
      </div>
      <div class="flex items-end justify-end gap-2">
        <span class="text-slate-400 text-sm total">‡∏£‡∏ß‡∏°: ‡∏ø0</span>
        <button class="btn bg-rose-700 remove">‡∏•‡∏ö</button>
      </div>
    </div>
  `;
  const nameInput = wrap.querySelector('.product-name');
  const qtyInput = wrap.querySelector('.qty');
  const priceInput = wrap.querySelector('.price');
  const totalSpan = wrap.querySelector('.total');

  function recalc(){ const t=(Number(qtyInput.value||0)*Number(priceInput.value||0)); totalSpan.textContent='‡∏£‡∏ß‡∏°: '+thb(t); }
  nameInput.addEventListener('input', ()=>{
    const p = products.find(x=> x.name.toLowerCase() === nameInput.value.trim().toLowerCase());
    if(p){
      nameInput.dataset.productId = p.id;
      priceInput.value = mode==='buy' ? (p.buyPrice||0) : (p.sellPrice||0);
      recalc();
    }else{
      delete nameInput.dataset.productId;
    }
  });
  qtyInput.addEventListener('input', recalc);
  priceInput.addEventListener('input', recalc);
  wrap.querySelector('.remove').onclick=()=>{ const parent=wrap.parentElement; if(parent.children.length>1) wrap.remove(); else alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); };
  return wrap;
}
function ensureOneRow(containerId, mode){
  const c = $('#'+containerId);
  if(!c.children.length) c.appendChild(makeItemRow(mode));
}

/* ------------------ Prevent Double Submit ------------------ */
let submitLocks = { buy:false, sell:false };
let lastHash = { buy:'', sell:'' };
function objHash(o){ try{ return btoa(unescape(encodeURIComponent(JSON.stringify(o)))).slice(-24); }catch(_){ return String(Math.random()); } }

/* ------------------ BUY Submit ------------------ */
$('#addBuyItem').onclick=()=>{ $('#buyItems').appendChild(makeItemRow('buy')); };
$('#buyResetBtn').onclick=()=>{ $('#buyItems').innerHTML=''; ensureOneRow('buyItems','buy'); };

$('#buySubmitBtn').onclick=async ()=>{
  if(submitLocks.buy) return;
  const date = toISODateClient($('#buyDate').value);
  const store = $('#buyStore').value;
  const items = [...$('#buyItems').children].map(div=>{
    const name=div.querySelector('.product-name').value.trim();
    const pid=div.querySelector('.product-name').dataset.productId||'';
    const qty=Number(div.querySelector('.qty').value||0);
    const price=Number(div.querySelector('.price').value||0);
    const prod = products.find(p=>p.id===pid || p.name.toLowerCase()===name.toLowerCase());
    if(!prod) return null;
    return { productId: prod.id, productName: prod.name, quantity: qty, price, total: qty*price, hasVat: !!prod.hasVat };
  }).filter(Boolean);
  if(!date || !store || !items.length) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  const total = items.reduce((s,i)=>s+i.total,0);
  const tx = { id: uid('b_'), date, store, items, total };

  const h = objHash(tx);
  if(h === lastHash.buy) return alert('‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
  lastHash.buy = h; submitLocks.buy=true; $('#buySubmitBtn').disabled=true;

  buyTransactions.push(tx); saveToStorage();
  const ok = await syncNow('buy-save');
  submitLocks.buy=false; $('#buySubmitBtn').disabled=false;
  if(ok) { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); $('#buyItems').innerHTML=''; ensureOneRow('buyItems','buy'); renderSummary(); }
};

/* ------------------ SELL Submit ------------------ */
$('#addSellItem').onclick=()=>{ $('#sellItems').appendChild(makeItemRow('sell')); };
$('#sellResetBtn').onclick=()=>{ $('#sellItems').innerHTML=''; ensureOneRow('sellItems','sell'); };

$('#sellSubmitBtn').onclick=async ()=>{
  if(submitLocks.sell) return;
  const date = toISODateClient($('#sellDate').value);
  const customer = $('#sellCustomer').value;
  const items = [...$('#sellItems').children].map(div=>{
    const name=div.querySelector('.product-name').value.trim();
    const pid=div.querySelector('.product-name').dataset.productId||'';
    const qty=Number(div.querySelector('.qty').value||0);
    const price=Number(div.querySelector('.price').value||0);
    const prod = products.find(p=>p.id===pid || p.name.toLowerCase()===name.toLowerCase());
    if(!prod) return null;
    return { productId: prod.id, productName: prod.name, quantity: qty, price, total: qty*price, hasVat: !!prod.hasVat };
  }).filter(Boolean);
  if(!date || !customer || !items.length) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  const total = items.reduce((s,i)=>s+i.total,0);
  const tx = { id: uid('s_'), date, customer, items, total };

  const h = objHash(tx);
  if(h === lastHash.sell) return alert('‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
  lastHash.sell = h; submitLocks.sell=true; $('#sellSubmitBtn').disabled=true;

  sellTransactions.push(tx); saveToStorage();
  const ok = await syncNow('sell-save');
  submitLocks.sell=false; $('#sellSubmitBtn').disabled=false;
  if(ok) { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); $('#sellItems').innerHTML=''; ensureOneRow('sellItems','sell'); renderSummary(); }
};

/* ------------------ LOAD / SETUP / SYNC ------------------ */
async function httpJson(url, opt={}, retry=0){
  const res = await fetch(url, opt);
  const text = await res.text();
  try{ return JSON.parse(text); }catch(_){ return { ok:false, error:text }; }
}
async function postPlainJson(url, payload){
  const res = await fetch(url, { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(payload) });
  const txt = await res.text(); try{ return JSON.parse(txt); }catch(_){ return { ok:false, error: txt }; }
}
function dedupAndSanitizeTx(arr){
  const map=new Map();
  (arr||[]).forEach(t=>{
    const id = String(t.id||uid('t_'));
    const date = toISODateClient(t.date);
    const items = (t.items||[]).filter(i=>i && i.productName && Number(i.quantity)>0);
    const total = items.reduce((s,i)=>s+Number(i.total||i.quantity*i.price||0),0);
    map.set(id, {...t,id,date,items,total});
  });
  return [...map.values()];
}
function prepareSnapshot(){
  products = (products||[]).map(p=>({...p, id: String(p.id||uid('p_'))}));
  buyTransactions = dedupAndSanitizeTx(buyTransactions);
  sellTransactions = dedupAndSanitizeTx(sellTransactions);
  saveToStorage();
}
function replaceStateFromServer(d){
  products = (d.products||[]).map(p=>({...p, id:String(p.id||uid('p_'))}));
  buyTransactions = dedupAndSanitizeTx(d.buyTransactions||[]);
  sellTransactions = dedupAndSanitizeTx(d.sellTransactions||[]);
  stores = Array.from(new Set(d.stores||[]));
  customers = Array.from(new Set((d.customers||[]).concat(['‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'])));
  categories = Array.from(new Set(d.categories||[]));
  saveToStorage();
}

$('#setupBtn').onclick=async ()=>{
  const u=getScriptUrl(); if(!u) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Script URL (/exec)');
  localStorage.setItem('scriptUrl', u);
  setSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤...','text-yellow-400');
  const r=await httpJson(u+'?action=setup');
  if(r?.ok){ setSyncStatus('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','text-emerald-400'); } else { setSyncStatus('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+(r?.error||'unknown'),'text-rose-400');}
};
$('#loadBtn').onclick=async ()=>{
  const u=getScriptUrl(); if(!u) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Script URL');
  localStorage.setItem('scriptUrl', u);
  setSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...','text-yellow-400');
  try{
    const d = await httpJson(u+'?action=load',{method:'GET'});
    if(d?.ok){
      replaceStateFromServer(d);
      refreshAllUI();
      setSyncStatus('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','text-emerald-400');
    }else{
      setSyncStatus('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(d?.error||'unknown'),'text-rose-400');
    }
  }catch(e){
    setSyncStatus('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e,'text-rose-400');
  }
};
$('#syncBtn').onclick=()=>syncNow('manual');

async function syncNow(reason='auto'){
  const u=getScriptUrl(); if(!u){ setSyncStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà URL','text-rose-400'); return false; }
  localStorage.setItem('scriptUrl', u);
  setSyncStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (${reason})...`,'text-yellow-400');

  prepareSnapshot();
  const payload={ products, stores, customers, categories, buyTransactions, sellTransactions, timestamp: new Date().toISOString() };
  try{
    const r=await postPlainJson(u, payload);
    if(r?.ok){ setSyncStatus(`‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${reason})`,'text-emerald-400'); return true; }
    setSyncStatus('‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+(r?.error||'unknown'),'text-rose-400'); return false;
  }catch(e){
    setSyncStatus('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e,'text-rose-400'); return false;
  }
}

/* ------------------ Summary & History ------------------ */
function aggForMonth(mode, month){
  const source = (mode==='buy') ? buyTransactions : sellTransactions;
  const arr = source.filter(t=> monthKeyFromDate(t.date)===month);
  const items = arr.flatMap(t=> t.items.map(i=>({...i, _actor: mode==='buy'? t.store : t.customer})));

  const byProduct = new Map();
  items.forEach(i=>{
    const k = i.productName;
    const cat = (products.find(p=>String(p.id)===String(i.productId))?.category)||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    if(!byProduct.has(k)) byProduct.set(k, {productName:k, category:cat, qty:0, amount:0});
    const x=byProduct.get(k); x.qty+=Number(i.quantity||0); x.amount+=Number(i.total||0);
  });

  const byCategory = new Map();
  [...byProduct.values()].forEach(p=>{
    if(!byCategory.has(p.category)) byCategory.set(p.category,{category:p.category, qty:0, amount:0});
    const x=byCategory.get(p.category); x.qty+=p.qty; x.amount+=p.amount;
  });

  const byActor = new Map();
  items.forEach(i=>{
    const a=i._actor||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    if(!byActor.has(a)) byActor.set(a,{actor:a, amount:0});
    byActor.get(a).amount += Number(i.total||0);
  });

  const totalQty = items.reduce((s,i)=>s+Number(i.quantity||0),0);
  const totalAmt = items.reduce((s,i)=>s+Number(i.total||0),0);
  const vatAmt = items.filter(i=>i.hasVat).reduce((s,i)=>s+Number(i.total||0)*0.07,0);

  return {
    items,
    arrP:[...byProduct.values()].sort((a,b)=>b.amount-a.amount),
    arrC:[...byCategory.values()].sort((a,b)=>b.amount-a.amount),
    arrA:[...byActor.values()].sort((a,b)=>b.amount-a.amount),
    totalQty, totalAmt, vatAmt
  };
}

function renderSummary(){
  const month = $('#sumMonth').value || new Date().toISOString().slice(0,7);
  $('#sumMonth').value = month;
  const mode = $('#sumMode').value;

  const b = aggForMonth('buy', month), s = aggForMonth('sell', month);
  const cur = (mode==='buy') ? b : s;
  $('#sumTotalQty').textContent = cur.totalQty.toLocaleString('th-TH');
  $('#sumTotalAmt').textContent = thb(cur.totalAmt);
  $('#sumVatAmt').textContent = thb(cur.vatAmt);
  $('#sumProfit').textContent = thb(s.totalAmt - b.totalAmt);

  $('#actorTitle').textContent = mode==='buy' ? '‡∏ï‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô' : '‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
  $('#actorCol').textContent = mode==='buy' ? '‡∏£‡πâ‡∏≤‡∏ô' : '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';

  $('#sumByProduct').innerHTML = cur.arrP.map(x=>`<tr><td class="p-1">${x.productName}</td><td class="p-1">${x.category}</td><td class="p-1">${x.qty.toLocaleString('th-TH')}</td><td class="p-1">${thb(x.amount)}</td></tr>`).join('') || `<tr><td colspan="4" class="p-2 text-center text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
  $('#sumByCategory').innerHTML = cur.arrC.map(x=>`<tr><td class="p-1">${x.category}</td><td class="p-1">${x.qty.toLocaleString('th-TH')}</td><td class="p-1">${thb(x.amount)}</td></tr>`).join('') || `<tr><td colspan="3" class="p-2 text-center text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
  $('#sumByActor').innerHTML = cur.arrA.map(x=>`<tr><td class="p-1">${x.actor}</td><td class="p-1">${thb(x.amount)}</td></tr>`).join('') || `<tr><td colspan="2" class="p-2 text-center text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;

  const buyRows = buyTransactions.filter(t=>monthKeyFromDate(t.date)===month).map(t=>`
    <tr class="border-b border-slate-700">
      <td class="p-2">${t.date}</td><td class="p-2">${t.store||'-'}</td><td class="p-2">${thb(t.total)}</td>
      <td class="p-2">
        <button class="text-amber-300" onclick="loadTxToForm('buy','${t.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <span class="mx-2 text-slate-600">|</span>
        <button class="text-rose-300" onclick="deleteTx('buy','${t.id}')">‡∏•‡∏ö</button>
      </td>
    </tr>`).join('');
  $('#buyHistory').innerHTML = buyRows || `<tr><td colspan="4" class="p-2 text-center text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`;

  const sellRows = sellTransactions.filter(t=>monthKeyFromDate(t.date)===month).map(t=>`
    <tr class="border-b border-slate-700">
      <td class="p-2">${t.date}</td><td class="p-2">${t.customer||'-'}</td><td class="p-2">${thb(t.total)}</td>
      <td class="p-2">
        <button class="text-amber-300" onclick="loadTxToForm('sell','${t.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <span class="mx-2 text-slate-600">|</span>
        <button class="text-rose-300" onclick="deleteTx('sell','${t.id}')">‡∏•‡∏ö</button>
      </td>
    </tr>`).join('');
  $('#sellHistory').innerHTML = sellRows || `<tr><td colspan="4" class="p-2 text-center text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`;
}

/* load tx to form for edit */
window.loadTxToForm = (mode,id)=>{
  const arr = mode==='buy'? buyTransactions : sellTransactions;
  const tx = arr.find(t=>t.id===id); if(!tx) return;
  $$('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.tab-btn[data-tab="${mode}"]`).classList.add('active');
  $$('.tabpane').forEach(p=>p.classList.add('hidden'));
  $('#'+mode).classList.remove('hidden');
  if(mode==='buy'){
    $('#buyDate').value = toISODateClient(tx.date);
    $('#buyStore').value = tx.store||'';
    $('#buyItems').innerHTML='';
    tx.items.forEach(()=>$('#buyItems').appendChild(makeItemRow('buy')));
    [...$('#buyItems').children].forEach((div,i)=>{
      const it=tx.items[i]; const name=div.querySelector('.product-name'); const qty=div.querySelector('.qty'); const price=div.querySelector('.price');
      const prod = products.find(p=>p.id===it.productId) || {name:it.productName};
      name.value = prod.name; name.dataset.productId = it.productId;
      qty.value = it.quantity; price.value = it.price;
      div.querySelector('.total').textContent = '‡∏£‡∏ß‡∏°: '+thb(it.total);
    });
    $('#buySubmitBtn').onclick=async ()=>{
      if(submitLocks.buy) return;
      const date = toISODateClient($('#buyDate').value);
      const store = $('#buyStore').value;
      const items = [...$('#buyItems').children].map(div=>{
        const nm=div.querySelector('.product-name').value.trim();
        const pid=div.querySelector('.product-name').dataset.productId||'';
        const qty=Number(div.querySelector('.qty').value||0);
        const price=Number(div.querySelector('.price').value||0);
        const prod = products.find(p=>p.id===pid || p.name.toLowerCase()===nm.toLowerCase());
        if(!prod) return null;
        return { productId: prod.id, productName: prod.name, quantity: qty, price, total: qty*price, hasVat: !!prod.hasVat };
      }).filter(Boolean);
      const total = items.reduce((s,i)=>s+i.total,0);
      Object.assign(tx,{date,store,items,total});
      saveToStorage(); const ok=await syncNow('buy-edit'); if(ok) alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      renderSummary();
    };
  }else{
    $('#sellDate').value = toISODateClient(tx.date);
    $('#sellCustomer').value = tx.customer||'';
    $('#sellItems').innerHTML='';
    tx.items.forEach(()=>$('#sellItems').appendChild(makeItemRow('sell')));
    [...$('#sellItems').children].forEach((div,i)=>{
      const it=tx.items[i]; const name=div.querySelector('.product-name'); const qty=div.querySelector('.qty'); const price=div.querySelector('.price');
      const prod = products.find(p=>p.id===it.productId) || {name:it.productName};
      name.value = prod.name; name.dataset.productId = it.productId;
      qty.value = it.quantity; price.value = it.price;
      div.querySelector('.total').textContent = '‡∏£‡∏ß‡∏°: '+thb(it.total);
    });
    $('#sellSubmitBtn').onclick=async ()=>{
      if(submitLocks.sell) return;
      const date = toISODateClient($('#sellDate').value);
      const customer = $('#sellCustomer').value;
      const items = [...$('#sellItems').children].map(div=>{
        const nm=div.querySelector('.product-name').value.trim();
        const pid=div.querySelector('.product-name').dataset.productId||'';
        const qty=Number(div.querySelector('.qty').value||0);
        const price=Number(div.querySelector('.price').value||0);
        const prod = products.find(p=>p.id===pid || p.name.toLowerCase()===nm.toLowerCase());
        if(!prod) return null;
        return { productId: prod.id, productName: prod.name, quantity: qty, price, total: qty*price, hasVat: !!prod.hasVat };
      }).filter(Boolean);
      const total = items.reduce((s,i)=>s+i.total,0);
      Object.assign(tx,{date,customer,items,total});
      saveToStorage(); const ok=await syncNow('sell-edit'); if(ok) alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      renderSummary();
    };
  }
};
window.deleteTx = async (mode,id)=>{
  if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
  if(mode==='buy'){ buyTransactions = buyTransactions.filter(t=>t.id!==id); }
  else { sellTransactions = sellTransactions.filter(t=>t.id!==id); }
  saveToStorage(); renderSummary(); const ok=await syncNow(mode+'-delete'); if(!ok) alert('Sync ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÅ‡∏ï‡πà‡∏•‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
};

/* ------------------ PDF (Client ‚Äî custom filters) ------------------ */
function formatCurrency(n){return new Intl.NumberFormat('th-TH',{style:'currency',currency:'THB'}).format(Number(n)||0);}
$('#pdfFilter').addEventListener('change',(e)=>{
  if(e.target.value==='actor'){ $('#actorSelectBox').classList.remove('hidden'); populateActorSelect(); }
  else { $('#actorSelectBox').classList.add('hidden'); }
});
$('#sumMonth').addEventListener('change',()=>{ if(!$('#actorSelectBox').classList.contains('hidden')) populateActorSelect(); renderSummary(); });
$('#sumMode').addEventListener('change',()=>{ if(!$('#actorSelectBox').classList.contains('hidden')) populateActorSelect(); renderSummary(); });

function populateActorSelect(){
  const month=$('#sumMonth').value;
  const mode=$('#sumMode').value;
  const {arrA}=aggForMonth(mode,month);
  $('#actorSelect').innerHTML = `<option value="__ALL__">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` + arrA.map(a=>`<option>${a.actor}</option>`).join('');
}
$('#exportCustomPdf').onclick=()=>{
  const month=$('#sumMonth').value;
  const mode=$('#sumMode').value;
  const filter=$('#pdfFilter').value;
  const actorPick = (filter==='actor') ? $('#actorSelect').value : '__ALL__';

  const { jsPDF } = window.jspdf; const doc = new jsPDF();
  doc.setFont('helvetica');
  const title = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô${mode==='buy'?'‡∏ã‡∏∑‡πâ‡∏≠':'‡∏Ç‡∏≤‡∏¢'} ‚Äî ${month} (${filter}${actorPick!=='__ALL__'?' : '+actorPick:''})`;
  doc.setFontSize(16); doc.text(title, 14, 16); doc.setFontSize(11);

  const {arrP,arrC,arrA,totalQty,totalAmt,items} = aggForMonth(mode,month);
  const itemsFiltered = (filter==='actor' && actorPick!=='__ALL__') ? items.filter(i=> i._actor===actorPick ) : items;

  const addTable=(head, body)=>doc.autoTable({ startY: doc.lastAutoTable? doc.lastAutoTable.finalY+8 : 22, head:[head], body });

  if(filter==='all'){
    addTable(['‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°'], arrP.map(r=>[r.productName,r.category,r.qty.toLocaleString('th-TH'), formatCurrency(r.amount)]));
  }else if(filter==='actor'){
    const rows = (actorPick==='__ALL__' ? arrA : [{actor:actorPick, amount: itemsFiltered.reduce((s,i)=>s+i.total,0)}])
               .map(r=>[r.actor, formatCurrency(r.amount)]);
    addTable([mode==='buy'?'‡∏£‡πâ‡∏≤‡∏ô':'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°'], rows);
    if(actorPick!=='__ALL__'){
      const byP=new Map(); itemsFiltered.forEach(i=>{
        const k=i.productName;
        if(!byP.has(k)) byP.set(k,{name:k,cat:(products.find(p=>String(p.id)===String(i.productId))?.category)||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',qty:0,amt:0});
        const x=byP.get(k); x.qty+=i.quantity; x.amt+=i.total;
      });
      const rows2=[...byP.values()].sort((a,b)=>b.amt-a.amt).map(x=>[x.name,x.cat,x.qty.toLocaleString('th-TH'),formatCurrency(x.amt)]);
      addTable(['‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°'], rows2);
    }
  }else if(filter==='category'){
    addTable(['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°'], arrC.map(r=>[r.category, r.qty.toLocaleString('th-TH'), formatCurrency(r.amount)]));
  }else if(filter==='vat'){
    const vatItems=itemsFiltered.filter(i=>i.hasVat);
    const byP=new Map(); vatItems.forEach(i=>{
      const k=i.productName;
      if(!byP.has(k)) byP.set(k,{name:k,cat:(products.find(p=>String(p.id)===String(i.productId))?.category)||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',qty:0,amt:0});
      const x=byP.get(k); x.qty+=i.quantity; x.amt+=i.total;
    });
    const rows=[...byP.values()].sort((a,b)=>b.amt-a.amt).map(x=>[x.name,x.cat,x.qty.toLocaleString('th-TH'),formatCurrency(x.amt)]);
    addTable(['‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (VAT)','‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°'], rows);
  }

  doc.autoTable({ startY: doc.lastAutoTable? doc.lastAutoTable.finalY+8 : 22,
    head:[['‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°']],
    body:[[mode==='buy'?'‡∏ã‡∏∑‡πâ‡∏≠':'‡∏Ç‡∏≤‡∏¢', totalQty.toLocaleString('th-TH'), formatCurrency(totalAmt)]] });

  doc.save(`‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô_${mode==='buy'?'‡∏ã‡∏∑‡πâ‡∏≠':'‡∏Ç‡∏≤‡∏¢'}_${month}_${filter}${actorPick!=='__ALL__'?'_'+actorPick:''}.pdf`);
};

/* ------------------ PDF (Server ‚Äî ‡πÉ‡∏ä‡πâ pdfx) ------------------ */
$('#generateServerPDF').onclick=$('#exportServerPdf').onclick=async ()=>{
  const u=getScriptUrl(); if(!u) return alert('‡πÉ‡∏™‡πà Script URL (/exec)');
  const month = ($('#reportMonth')?.value) || ($('#sumMonth')?.value) || new Date().toISOString().slice(0,7);
  const mode   = ($('#sumMode')?.value) || 'buy';
  const filter = ($('#pdfFilter')?.value) || 'all';
  const actor  = (filter==='actor') ? (($('#actorSelect')?.value)||'') : '';

  setSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå...','text-yellow-400');
  const q = new URLSearchParams({ action:'pdfx', month, mode, filter, actor });
  const r = await httpJson(`${u}?${q.toString()}`, { method:'GET' });

  if(r?.ok && r.url){ window.open(r.url,'_blank'); setSyncStatus('‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢','text-emerald-400'); }
  else setSyncStatus('‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(r?.error||'unknown'),'text-rose-400');
};

/* ------------------ Build Initial UI ------------------ */
function refreshAllUI(){
  refreshStoreCustomer();
  refreshCategories();
  refreshProductTable();
  refreshProductDatalist();
  $('#buyItems').innerHTML=''; ensureOneRow('buyItems','buy');
  $('#sellItems').innerHTML=''; ensureOneRow('sellItems','sell');
  const now=new Date(); $('#sumMonth').value = now.toISOString().slice(0,7);
}
refreshAllUI();
renderSummary();
</script>
</body>
</html>