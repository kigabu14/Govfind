<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>üè™ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Äî Plug2Plug</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Sarabun', sans-serif;
      background: linear-gradient(135deg,#1e1b4b 0%,#7c2d12 25%,#1e40af 50%,#991b1b 75%,#1e1b4b 100%);
      background-size: 400% 400%; animation: gradientShift 15s ease infinite; }
    @keyframes gradientShift { 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }
    .tab-content{display:none}.tab-content.active{display:block}
    .glass-effect{background:rgba(255,255,255,.08);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.18)}
    .dark-glass{background:rgba(0,0,0,.3);backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.1)}
    .neon-glow{box-shadow:0 0 20px rgba(59,130,246,.5)}
    .red-glow{box-shadow:0 0 20px rgba(239,68,68,.5)}
    .input-error{outline:2px solid #ef4444;border-color:#ef4444!important}
    .badge{padding:.15rem .5rem;border-radius:.75rem;font-size:.75rem;border:1px solid}
  </style>
</head>
<body class="min-h-screen text-white">
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-5xl font-bold text-white mb-4 drop-shadow-2xl">üè™ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
      <p class="text-gray-200 text-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‚Äî autosync to Google Sheets</p>
    </div>

    <!-- Nav -->
    <div class="dark-glass rounded-xl shadow-2xl mb-8">
      <div class="flex flex-wrap border-b border-gray-600">
        <button class="tab-btn px-6 py-4 font-medium text-blue-400 border-b-2 border-blue-400 neon-glow" data-tab="buy">üõí ‡∏´‡∏ô‡πâ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        <button class="tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white hover:neon-glow transition-all" data-tab="sell">üí∞ ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        <button class="tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white hover:neon-glow transition-all" data-tab="products">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        <button class="tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white hover:neon-glow transition-all" data-tab="summary">üìä ‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠</button>
        <button class="tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white hover:red-glow transition-all" data-tab="reports">üìÑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
      </div>
      <!-- Script URL + controls -->
      <div class="p-4 flex flex-col md:flex-row gap-3 items-start md:items-center">
        <div class="flex-1 w-full">
          <label class="block text-sm text-gray-300 mb-1">Google Apps Script URL (Web App ‚Äî /exec ‡∏´‡∏£‡∏∑‡∏≠ /dev)</label>
          <input id="scriptUrl" type="url" placeholder="https://script.google.com/macros/s/.../exec" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 text-white rounded-lg" />
        </div>
        <div class="flex gap-2">
          <button id="setupSheetsBtn" class="px-3 py-2 bg-gradient-to-r from-slate-600 to-slate-700 rounded-lg">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
          <button id="loadFromSheetsBtn" class="px-3 py-2 bg-gradient-to-r from-purple-500 to-violet-600 rounded-lg">üì• ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Sheets</button>
          <button id="syncToSheetsBtn" class="px-3 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg">üìä ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Sheets</button>
        </div>
        <div id="syncStatus" class="text-sm text-gray-300">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
      </div>
    </div>

    <!-- Buy -->
    <div id="buy" class="tab-content active">
      <div class="dark-glass rounded-xl shadow-2xl p-6">
        <h2 class="text-2xl font-bold mb-6">üõí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
        <form id="buyForm" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm text-gray-200 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input type="date" id="buyDate" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required>
            </div>
            <div>
              <label class="block text-sm text-gray-200 mb-2">‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
              <div class="flex gap-2">
                <select id="buyStore" class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required>
                  <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô</option>
                </select>
                <button type="button" id="addStoreBtn" class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô</button>
              </div>
            </div>
          </div>
          <div class="border-t border-gray-600 pt-6">
            <h3 class="text-lg font-semibold mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <div id="buyItems">
              <div class="buy-item grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 glass-effect rounded-lg border border-gray-600">
                <div>
                  <label class="block text-sm text-gray-200 mb-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                  <select class="product-select w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option></select>
                </div>
                <div>
                  <label class="block text-sm text-gray-200 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                  <input type="number" class="quantity-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" min="1" value="1" required>
                </div>
                <div>
                  <label class="block text-sm text-gray-200 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)</label>
                  <input type="number" class="price-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" step="0.01" min="0" required>
                </div>
                <div class="flex items-end">
                  <button type="button" class="remove-item w-full px-3 py-2 bg-gradient-to-r from-red-500 to-red-600 rounded-lg">‡∏•‡∏ö</button>
                </div>
              </div>
            </div>
            <button type="button" id="addBuyItem" class="mb-4 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          </div>
          <div class="flex justify-end">
            <button type="submit" class="px-8 py-3 bg-gradient-to-r from-gray-800 to-black rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Sell -->
    <div id="sell" class="tab-content">
      <div class="dark-glass rounded-xl shadow-2xl p-6">
        <h2 class="text-2xl font-bold mb-6">üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
        <form id="sellForm" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm text-gray-200 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input type="date" id="sellDate" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required>
            </div>
            <div>
              <label class="block text-sm text-gray-200 mb-2">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
              <div class="flex gap-2">
                <select id="sellCustomer" class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required>
                  <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>
                </select>
                <button type="button" id="addCustomerBtn" class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
              </div>
            </div>
          </div>
          <div class="border-t border-gray-600 pt-6">
            <h3 class="text-lg font-semibold mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <div id="sellItems">
              <div class="sell-item grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 glass-effect rounded-lg border border-gray-600">
                <div>
                  <label class="block text-sm text-gray-200 mb-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                  <select class="product-select w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option></select>
                </div>
                <div>
                  <label class="block text-sm text-gray-200 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                  <input type="number" class="quantity-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" min="1" value="1" required>
                </div>
                <div>
                  <label class="block text-sm text-gray-200 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ø)</label>
                  <input type="number" class="price-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" step="0.01" min="0" required>
                </div>
                <div class="flex items-end">
                  <button type="button" class="remove-item w-full px-3 py-2 bg-gradient-to-r from-red-500 to-red-600 rounded-lg">‡∏•‡∏ö</button>
                </div>
              </div>
            </div>
            <button type="button" id="addSellItem" class="mb-4 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          </div>
          <div class="flex justify-end">
            <button type="submit" class="px-8 py-3 bg-gradient-to-r from-gray-800 to-black rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Products -->
    <div id="products" class="tab-content">
      <div class="dark-glass rounded-xl shadow-2xl p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
          <button id="addProductBtn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        </div>
        <div id="productForm" class="hidden mb-6 p-4 dark-glass rounded-lg">
          <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
          <form id="addProductForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div><label class="block text-sm mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input id="productName" type="text" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required></div>
            <div>
              <label class="block text-sm mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
              <div class="flex gap-2">
                <select id="productCategory" class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required>
                  <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                  <option>‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option><option>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option><option>‡∏Ç‡∏ô‡∏°</option><option>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                </select>
                <button type="button" id="addCategoryBtn" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î</button>
              </div>
            </div>
            <div><label class="block text-sm mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ø)</label><input id="productBuyPrice" type="number" step="0.01" min="0" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required></div>
            <div><label class="block text-sm mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ø)</label><input id="productSellPrice" type="number" step="0.01" min="0" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required></div>
            <div class="flex items-center"><input id="productHasVat" type="checkbox" class="mr-2"><label for="productHasVat" class="text-sm">‡∏°‡∏µ VAT 7%</label></div>
            <div class="flex gap-2">
              <button type="submit" class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              <button type="button" id="cancelProductBtn" class="px-4 py-2 bg-gradient-to-r from-gray-600 to-gray-700 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
          </form>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-gray-600">
                <th class="text-left py-3 px-4">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="text-left py-3 px-4">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                <th class="text-left py-3 px-4">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠</th>
                <th class="text-left py-3 px-4">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                <th class="text-left py-3 px-4">VAT</th>
                <th class="text-left py-3 px-4">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° VAT</th>
                <th class="text-left py-3 px-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="productsTable">
              <tr><td colspan="7" class="text-center py-8 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Reports -->
    <div id="reports" class="tab-content">
      <div class="space-y-6">
        <div class="dark-glass rounded-xl shadow-2xl p-6">
          <h2 class="text-2xl font-bold mb-6">üìÑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
              <label class="block text-sm mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
              <input type="month" id="reportMonth" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg">
            </div>
            <div class="flex items-end gap-2">
              <button id="generatePDFBtn" class="px-6 py-2 bg-gradient-to-r from-red-500 to-pink-600 rounded-lg red-glow">üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF</button>
              <span class="badge text-gray-300 border-gray-500">‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô / ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á</span>
            </div>
          </div>
          <div class="border-t border-gray-600 pt-6">
            <h3 class="text-lg font-semibold mb-4">üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets</h3>
            <div id="syncStatus2" class="text-sm text-gray-300">‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡πÄ‡∏ô‡πá‡∏ï‡∏•‡πà‡∏° ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô</div>
          </div>
        </div>

        <div class="dark-glass rounded-xl shadow-2xl p-6">
          <h3 class="text-lg font-semibold mb-4">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
          <div id="monthlyPreview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="glass-effect p-4 rounded-lg text-center"><div class="text-2xl font-bold text-blue-400" id="totalBuyAmount">‡∏ø0</div><div class="text-sm text-gray-300">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°</div></div>
            <div class="glass-effect p-4 rounded-lg text-center"><div class="text-2xl font-bold text-green-400" id="totalSellAmount">‡∏ø0</div><div class="text-sm text-gray-300">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div></div>
            <div class="glass-effect p-4 rounded-lg text-center"><div class="text-2xl font-bold text-red-400" id="totalVatAmount">‡∏ø0</div><div class="text-sm text-gray-300">VAT ‡∏£‡∏ß‡∏°</div></div>
            <div class="glass-effect p-4 rounded-lg text-center"><div class="text-2xl font-bold text-yellow-400" id="totalProfit">‡∏ø0</div><div class="text-sm text-gray-300">‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Summary -->
    <div id="summary" class="tab-content">
      <div class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="dark-glass rounded-xl shadow-2xl p-6">
            <h3 class="text-lg font-semibold mb-4">‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏µ VAT</h3>
            <div class="space-y-2">
              <div class="flex justify-between"><span class="text-gray-300">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</span><span id="vatItemsCount" class="font-semibold">0</span></div>
              <div class="flex justify-between"><span class="text-gray-300">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT):</span><span id="vatSubtotal" class="font-semibold">‡∏ø0</span></div>
              <div class="flex justify-between"><span class="text-gray-300">VAT 7%:</span><span id="vatAmount" class="font-semibold text-red-400">‡∏ø0</span></div>
              <div class="flex justify-between border-t border-gray-600 pt-2"><span class="font-medium">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏£‡∏ß‡∏° VAT):</span><span id="vatTotal" class="font-bold text-green-400">‡∏ø0</span></div>
            </div>
          </div>
          <div class="dark-glass rounded-xl shadow-2xl p-6">
            <h3 class="text-lg font-semibold mb-4">‚ùå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏°‡∏µ VAT</h3>
            <div class="space-y-2">
              <div class="flex justify-between"><span class="text-gray-300">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</span><span id="noVatItemsCount" class="font-semibold">0</span></div>
              <div class="flex justify-between border-t border-gray-600 pt-2"><span class="font-medium">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span><span id="noVatTotal" class="font-bold text-blue-400">‡∏ø0</span></div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="dark-glass rounded-xl shadow-2xl p-6">
            <h3 class="text-lg font-semibold mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ VAT</h3>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead><tr class="border-b border-gray-600"><th class="text-left py-2 px-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="text-left py-2 px-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="text-left py-2 px-2">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th class="text-left py-2 px-2">‡∏£‡∏ß‡∏°</th></tr></thead>
                <tbody id="vatItemsList"><tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr></tbody>
              </table>
            </div>
          </div>
          <div class="dark-glass rounded-xl shadow-2xl p-6">
            <h3 class="text-lg font-semibold mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ VAT</h3>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead><tr class="border-b border-gray-600"><th class="text-left py-2 px-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="text-left py-2 px-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="text-left py-2 px-2">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th class="text-left py-2 px-2">‡∏£‡∏ß‡∏°</th></tr></thead>
                <tbody id="noVatItemsList"><tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div> <!-- container -->

  <script>
    /* ========= Local Storage ========= */
    let products = JSON.parse(localStorage.getItem('products')) || [];
    let stores = JSON.parse(localStorage.getItem('stores')) || ['‡πÄ‡∏ã‡πÄ‡∏ß‡πà‡∏ô','‡πÇ‡∏•‡∏ï‡∏±‡∏™','‡∏ö‡∏¥‡πä‡∏Å‡∏ã‡∏µ','‡πÅ‡∏°‡πá‡∏Ñ‡πÇ‡∏Ñ‡∏£'];
    let customers = JSON.parse(localStorage.getItem('customers')) || ['‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'];
    let categories = JSON.parse(localStorage.getItem('categories')) || ['‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°','‡∏Ç‡∏ô‡∏°','‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ','‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];
    let buyTransactions = JSON.parse(localStorage.getItem('buyTransactions')) || [];
    let sellTransactions = JSON.parse(localStorage.getItem('sellTransactions')) || [];

    function saveToStorage(){
      localStorage.setItem('products', JSON.stringify(products));
      localStorage.setItem('stores', JSON.stringify(stores));
      localStorage.setItem('customers', JSON.stringify(customers));
      localStorage.setItem('categories', JSON.stringify(categories));
      localStorage.setItem('buyTransactions', JSON.stringify(buyTransactions));
      localStorage.setItem('sellTransactions', JSON.stringify(sellTransactions));
    }
    function formatCurrency(n){ return new Intl.NumberFormat('th-TH',{style:'currency',currency:'THB'}).format(n||0); }

    /* ========= Tabs ========= */
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click',function(){
        const tabId=this.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach(b=>b.className='tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white hover:neon-glow transition-all');
        if(tabId==='reports') this.className='tab-btn px-6 py-4 font-medium text-red-400 border-b-2 border-red-400 red-glow';
        else this.className='tab-btn px-6 py-4 font-medium text-blue-400 border-b-2 border-blue-400 neon-glow';
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if(tabId==='summary') updateSummary();
        if(tabId==='reports'){ updateMonthlyPreview(); const now=new Date(); document.getElementById('reportMonth').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; }
      });
    });

    /* ========= Dropdown Updates ========= */
    function updateStoreDropdowns(){
      const s=document.getElementById('buyStore');
      s.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô</option>'+stores.map(v=>`<option>${v}</option>`).join('');
    }
    function ensureDefaultCustomer(){
      if(!Array.isArray(customers)) customers=[];
      if(!customers.includes('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ')) customers=['‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', ...customers];
    }
    function updateCustomerDropdowns(){
      ensureDefaultCustomer();
      const s=document.getElementById('sellCustomer');
      const cur=s.value;
      s.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>'+customers.map(v=>`<option>${v}</option>`).join('');
      s.value = cur || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
    }
    function updateCategoryDropdowns(){
      const sel=document.getElementById('productCategory'); const cur=sel.value;
      sel.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>'+categories.map(v=>`<option>${v}</option>`).join('');
      sel.value=cur;
    }
    function updateProductDropdowns(){
      document.querySelectorAll('.product-select').forEach(sel=>{
        const cur=sel.value;
        sel.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>'+products.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
        sel.value=cur;
      });
    }
    function updateProductsTable(){
      const tbody=document.getElementById('productsTable');
      if(!products.length){ tbody.innerHTML='<tr><td colspan="7" class="text-center py-8 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>'; return; }
      tbody.innerHTML=products.map(p=>{
        const vatPrice=p.hasVat? p.sellPrice*1.07 : p.sellPrice;
        return `<tr class="border-b border-gray-600 hover:bg-gray-800/50">
          <td class="py-3 px-4">${p.name}</td>
          <td class="py-3 px-4">${p.category}</td>
          <td class="py-3 px-4">${formatCurrency(p.buyPrice)}</td>
          <td class="py-3 px-4">${formatCurrency(p.sellPrice)}</td>
          <td class="py-3 px-4"><span class="badge ${p.hasVat?'text-green-300 border-green-500 bg-green-600/20':'text-gray-300 border-gray-500 bg-gray-600/20'}">${p.hasVat?'‡∏°‡∏µ VAT':'‡πÑ‡∏°‡πà‡∏°‡∏µ VAT'}</span></td>
          <td class="py-3 px-4 font-semibold">${formatCurrency(vatPrice)}</td>
          <td class="py-3 px-4"><button onclick="deleteProduct(${p.id})" class="text-red-400 hover:text-red-300 text-sm">üóëÔ∏è ‡∏•‡∏ö</button></td>
        </tr>`;
      }).join('');
    }
    function deleteProduct(id){
      if(confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){
        products = products.filter(p=>p.id!==id);
        saveToStorage(); updateProductsTable(); updateProductDropdowns();
        syncNow('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
      }
    }

    /* ========= Item rows ========= */
    function addBuyItem(){
      const c=document.getElementById('buyItems');
      const d=document.createElement('div');
      d.className='buy-item grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 glass-effect rounded-lg border border-gray-600';
      d.innerHTML=`
        <div><label class="block text-sm text-gray-200 mb-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <select class="product-select w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option></select></div>
        <div><label class="block text-sm text-gray-200 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
          <input type="number" class="quantity-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" min="1" value="1" required></div>
        <div><label class="block text-sm text-gray-200 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)</label>
          <input type="number" class="price-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" step="0.01" min="0" required></div>
        <div class="flex items-end"><button type="button" class="remove-item w-full px-3 py-2 bg-gradient-to-r from-red-500 to-red-600 rounded-lg">‡∏•‡∏ö</button></div>`;
      c.appendChild(d); updateProductDropdowns();
    }
    function addSellItem(){
      const c=document.getElementById('sellItems');
      const d=document.createElement('div');
      d.className='sell-item grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 glass-effect rounded-lg border border-gray-600';
      d.innerHTML=`
        <div><label class="block text-sm text-gray-200 mb-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <select class="product-select w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option></select></div>
        <div><label class="block text-sm text-gray-200 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
          <input type="number" class="quantity-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" min="1" value="1" required></div>
        <div><label class="block text-sm text-gray-200 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ø)</label>
          <input type="number" class="price-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" step="0.01" min="0" required></div>
        <div class="flex items-end"><button type="button" class="remove-item w-full px-3 py-2 bg-gradient-to-r from-red-500 to-red-600 rounded-lg">‡∏•‡∏ö</button></div>`;
      c.appendChild(d); updateProductDropdowns();
    }
    document.getElementById('addBuyItem').addEventListener('click',addBuyItem);
    document.getElementById('addSellItem').addEventListener('click',addSellItem);
    document.addEventListener('click',e=>{
      if(e.target.classList.contains('remove-item')){
        const row=e.target.closest('.buy-item, .sell-item'); const box=row.parentElement;
        if(box.children.length>1) row.remove(); else alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
      }
    });
    document.addEventListener('change',e=>{
      if(e.target.classList.contains('product-select')){
        const pid=Number(e.target.value);
        const p=products.find(x=>x.id===pid);
        if(p){
          const row=e.target.closest('.buy-item, .sell-item');
          row.querySelector('.price-input').value = row.classList.contains('buy-item') ? p.buyPrice : p.sellPrice;
        }
      }
    });

    /* ========= Network helpers ========= */
    const isFileScheme = () => location.protocol==='file:';
    const getScriptUrl = () => (document.getElementById('scriptUrl')?.value || localStorage.getItem('scriptUrl') || '').trim();
    const rememberScriptUrl = () => { const u=getScriptUrl(); if(u) localStorage.setItem('scriptUrl',u); };

    function setSyncStatus(msg,color='text-gray-300'){
      const el=document.getElementById('syncStatus'); if(el){ el.textContent=msg; el.className=`text-sm ${color}`; }
      const el2=document.getElementById('syncStatus2'); if(el2&&color.includes('green')){ el2.textContent=msg; el2.className=`text-sm ${color}`; }
    }
    function errorToString(err){ if(!err) return 'Unknown'; return (err.name||'Error')+(err.message?': '+err.message:''); }

    async function httpJson(url, {method='GET', headers={}, body=null, timeoutMs=12000}={}, retries=1){
      for(let a=0;a<=retries;a++){
        const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
        try{
          const res=await fetch(url,{method,headers,body,signal:ctrl.signal});
          clearTimeout(t);
          const text=await res.text(); let data={}; try{ data=text?JSON.parse(text):{} }catch(_){}
          if(!res.ok){ throw new Error((data&&data.error)||text||`HTTP ${res.status}`); }
          return data;
        }catch(err){
          clearTimeout(t);
          if(a===retries) throw err;
          await new Promise(r=>setTimeout(r,600*(a+1)));
        }
      }
    }

    function looksLikeAppsScript(url){
      return /^https:\/\/script\.google\.com\/macros\/s\/[A-Za-z0-9_-]+\/(exec|dev)(\?.*)?$/.test(url);
    }

    async function ping(scriptUrl){
      setSyncStatus('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...', 'text-yellow-400');
      const r = await httpJson(scriptUrl, {method:'GET', timeoutMs:6000}, 1);
      return r;
    }

    async function syncNow(reason='auto'){
      if(isFileScheme()){ setSyncStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô http(s):// ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà file://', 'text-red-400'); return {ok:false,error:'FILE_SCHEME'}; }
      const scriptUrl=getScriptUrl(); if(!scriptUrl){ setSyncStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà Apps Script URL', 'text-red-400'); return {ok:false,error:'NO_URL'}; }
      if(!looksLikeAppsScript(scriptUrl)){ setSyncStatus('URL ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Web App (/exec ‡∏´‡∏£‡∏∑‡∏≠ /dev)', 'text-red-400'); return {ok:false,error:'BAD_URL'}; }

      try{ await ping(scriptUrl); }catch(err){ setSyncStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+errorToString(err),'text-red-400'); return {ok:false,error:'PING_FAIL'}; }

      setSyncStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (${reason})...`, 'text-yellow-400');
      try{
        const payload={ products, buyTransactions, sellTransactions, stores, customers, categories, timestamp:new Date().toISOString() };
        const data=await httpJson(scriptUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload),timeoutMs:15000},2);
        if(data&&data.ok){ setSyncStatus(`‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${reason})`,'text-green-400'); return {ok:true}; }
        setSyncStatus(`‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data?.error||'unknown'}`,'text-red-400'); return {ok:false};
      }catch(err){
        setSyncStatus('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+errorToString(err),'text-red-400'); return {ok:false};
      }
    }

    /* ========= Load / Setup / PDF ========= */
    document.getElementById('setupSheetsBtn').addEventListener('click', async ()=>{
      try{
        const u=getScriptUrl(); if(!u) return alert('‡πÉ‡∏™‡πà Apps Script URL ‡∏Å‡πà‡∏≠‡∏ô');
        rememberScriptUrl();
        setSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (setup)...','text-yellow-400');
        const r=await httpJson(`${u}?action=setup`,{method:'GET',timeoutMs:12000},1);
        if(r?.ok){ setSyncStatus('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!','text-green-400'); }
        else setSyncStatus('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','text-red-400');
      }catch(e){ setSyncStatus('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+errorToString(e),'text-red-400'); }
    });

    document.getElementById('loadFromSheetsBtn').addEventListener('click', async ()=>{
      try{
        const u=getScriptUrl(); if(!u) return alert('‡πÉ‡∏™‡πà Apps Script URL ‡∏Å‡πà‡∏≠‡∏ô');
        rememberScriptUrl();
        setSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...','text-yellow-400');
        const data=await httpJson(`${u}?action=load`,{method:'GET',timeoutMs:15000},2);
        if(data.products) products=data.products;
        if(data.buyTransactions) buyTransactions=data.buyTransactions;
        if(data.sellTransactions) sellTransactions=data.sellTransactions;
        if(data.stores) stores=data.stores;
        if(data.customers) customers=data.customers;
        if(data.categories) categories=data.categories;
        saveToStorage(); init(); setSyncStatus('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!','text-green-400');
      }catch(e){ setSyncStatus('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+errorToString(e),'text-red-400'); }
    });

    document.getElementById('syncToSheetsBtn').addEventListener('click', ()=>{ rememberScriptUrl(); syncNow('‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); });

    document.getElementById('generatePDFBtn').addEventListener('click', async function(){
      const month=document.getElementById('reportMonth').value;
      if(!month) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô');
      const btn=this; btn.disabled=true; const old=btn.textContent; btn.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...';
      try{
        const u=getScriptUrl();
        if(u && looksLikeAppsScript(u) && !isFileScheme()){
          try{
            const r=await httpJson(`${u}?action=pdf&month=${encodeURIComponent(month)}`,{method:'GET',timeoutMs:25000},1);
            if(r?.ok && (r.downloadUrl||r.url)){ window.open(r.downloadUrl||r.url,'_blank'); btn.textContent=old; btn.disabled=false; return; }
          }catch(e){ /* fallback */ }
        }
        // fallback: client-side PDF (3 ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
        generateMonthlyPDF(month);
      } finally { btn.textContent=old; btn.disabled=false; }
    });

    /* ========= Validation + Submit ========= */
    function validateLineItems(containerSelector, mode){
      const rows=[...document.querySelectorAll(containerSelector+' .'+(mode==='buy'?'buy-item':'sell-item'))];
      let ok=true, messages=[];
      rows.forEach(row=>{
        const sel=row.querySelector('.product-select');
        const qty=row.querySelector('.quantity-input');
        const price=row.querySelector('.price-input');
        [sel,qty,price].forEach(el=>el&&el.classList.remove('input-error'));
        const pid=Number(sel?.value||NaN), q=Number(qty?.value||NaN), p=Number(price?.value||NaN);
        if(!pid || !products.find(x=>x.id===pid)){ ok=false; sel?.classList.add('input-error'); }
        if(!(q>0)){ ok=false; qty?.classList.add('input-error'); }
        if(!(p>=0)){ ok=false; price?.classList.add('input-error'); }
      });
      if(!ok) messages.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (>0) ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î');
      if(mode==='buy'){
        const store=document.getElementById('buyStore'); if(!store.value){ ok=false; store.classList.add('input-error'); messages.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠'); }
        else store.classList.remove('input-error');
      }else{
        const cust=document.getElementById('sellCustomer'); if(!cust.value){ ok=false; cust.classList.add('input-error'); messages.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'); }
        else cust.classList.remove('input-error');
      }
      return { ok, message: messages.join('\n') };
    }

    document.getElementById('buyForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const v=validateLineItems('#buyItems','buy'); if(!v.ok) return alert(v.message);
      const date=document.getElementById('buyDate').value; const store=document.getElementById('buyStore').value;
      const items=[];
      document.querySelectorAll('.buy-item').forEach(row=>{
        const pid=Number(row.querySelector('.product-select').value);
        const q=Number(row.querySelector('.quantity-input').value);
        const p=Number(row.querySelector('.price-input').value);
        if(pid && q>0 && p>=0){
          const prod=products.find(x=>x.id===pid);
          items.push({productId:pid,productName:prod.name,quantity:q,price:p,total:q*p,hasVat:prod.hasVat});
        }
      });
      buyTransactions.push({id:Date.now(),date,store,items,total:items.reduce((s,i)=>s+i.total,0)});
      saveToStorage(); await syncNow('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠'); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
      // reset rows
      this.reset(); document.getElementById('buyDate').value=new Date().toISOString().split('T')[0];
      const box=document.getElementById('buyItems'); box.innerHTML='';
      addBuyItem(); updateProductDropdowns();
    });

    document.getElementById('sellForm').addEventListener('submit', async function(e){
      e.preventDefault(); ensureDefaultCustomer(); updateCustomerDropdowns();
      const v=validateLineItems('#sellItems','sell'); if(!v.ok) return alert(v.message);
      const date=document.getElementById('sellDate').value; const customer=document.getElementById('sellCustomer').value;
      const items=[];
      document.querySelectorAll('.sell-item').forEach(row=>{
        const pid=Number(row.querySelector('.product-select').value);
        const q=Number(row.querySelector('.quantity-input').value);
        const p=Number(row.querySelector('.price-input').value);
        if(pid && q>0 && p>=0){
          const prod=products.find(x=>x.id===pid);
          items.push({productId:pid,productName:prod.name,quantity:q,price:p,total:q*p,hasVat:prod.hasVat});
        }
      });
      sellTransactions.push({id:Date.now(),date,customer,items,total:items.reduce((s,i)=>s+i.total,0)});
      saveToStorage(); await syncNow('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≤‡∏¢'); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
      this.reset(); document.getElementById('sellDate').value=new Date().toISOString().split('T')[0];
      const box=document.getElementById('sellItems'); box.innerHTML=''; addSellItem(); updateProductDropdowns(); updateCustomerDropdowns();
    });

    /* ========= Summary & Preview ========= */
    function updateSummary(){
      const all=[]; buyTransactions.forEach(t=>t.items.forEach(i=>all.push(i))); sellTransactions.forEach(t=>t.items.forEach(i=>all.push(i)));
      const vat=all.filter(i=>i.hasVat), novat=all.filter(i=>!i.hasVat);
      const vsub=vat.reduce((s,i)=>s+i.total,0), v7=vsub*0.07, vtot=vsub+v7;
      const ntot=novat.reduce((s,i)=>s+i.total,0);
      document.getElementById('vatItemsCount').textContent=vat.length;
      document.getElementById('vatSubtotal').textContent=formatCurrency(vsub);
      document.getElementById('vatAmount').textContent=formatCurrency(v7);
      document.getElementById('vatTotal').textContent=formatCurrency(vtot);
      document.getElementById('noVatItemsCount').textContent=novat.length;
      document.getElementById('noVatTotal').textContent=formatCurrency(ntot);
      const tbodyV=document.getElementById('vatItemsList'); const tbodyN=document.getElementById('noVatItemsList');
      tbodyV.innerHTML = vat.length? vat.map(i=>`<tr class="border-b border-gray-600"><td class="py-2 px-2">${i.productName}</td><td class="py-2 px-2">${i.quantity}</td><td class="py-2 px-2">${formatCurrency(i.price)}</td><td class="py-2 px-2 font-semibold">${formatCurrency(i.total)}</td></tr>`).join('') : '<tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
      tbodyN.innerHTML = novat.length? novat.map(i=>`<tr class="border-b border-gray-600"><td class="py-2 px-2">${i.productName}</td><td class="py-2 px-2">${i.quantity}</td><td class="py-2 px-2">${formatCurrency(i.price)}</td><td class="py-2 px-2 font-semibold">${formatCurrency(i.total)}</td></tr>`).join('') : '<tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
    }
    function getMonthlyData(month){
      const [Y,M]=month.split('-'); const filt=t=>{const d=new Date(t.date); return d.getFullYear()==Y && (d.getMonth()+1)==Number(M);};
      const monthlyBuy=buyTransactions.filter(filt); const monthlySell=sellTransactions.filter(filt);
      const all=[]; monthlyBuy.forEach(t=>all.push(...t.items)); monthlySell.forEach(t=>all.push(...t.items));
      const vat=all.filter(i=>i.hasVat);
      const totalBuy=monthlyBuy.reduce((s,t)=>s+t.total,0), totalSell=monthlySell.reduce((s,t)=>s+t.total,0), totalVat=vat.reduce((s,i)=>s+i.total*0.07,0);
      return {buyTransactions:monthlyBuy, sellTransactions:monthlySell, vatItems:vat, totalBuy, totalSell, totalVat, profit: totalSell-totalBuy};
    }
    function updateMonthlyPreview(){
      const now=new Date(); const m=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      const md=getMonthlyData(m);
      document.getElementById('totalBuyAmount').textContent=formatCurrency(md.totalBuy);
      document.getElementById('totalSellAmount').textContent=formatCurrency(md.totalSell);
      document.getElementById('totalVatAmount').textContent=formatCurrency(md.totalVat);
      document.getElementById('totalProfit').textContent=formatCurrency(md.profit);
    }

    /* ========= Client PDF Fallback ========= */
    function generateMonthlyPDF(month){
      const { jsPDF }=window.jspdf; const doc=new jsPDF(); doc.setFont('helvetica');
      doc.setFontSize(20); doc.text('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',105,18,{align:'center'});
      doc.setFontSize(12); doc.text(`‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${month}`,105,26,{align:'center'});
      const md=getMonthlyData(month); let y=34;
      // Page 1: ‡∏ã‡∏∑‡πâ‡∏≠
      doc.setFontSize(14); doc.text('‡∏´‡∏ô‡πâ‡∏≤ 1: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠',14,y); y+=6;
      doc.autoTable({ startY:y, head:[['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏£‡πâ‡∏≤‡∏ô','‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°']], body: md.buyTransactions.map(t=>[t.date,t.store,t.items.map(i=>`${i.productName} (${i.quantity})`).join(', '),formatCurrency(t.total)]) });
      // Page 2: ‡∏Ç‡∏≤‡∏¢
      doc.addPage(); y=20; doc.setFontSize(14); doc.text('‡∏´‡∏ô‡πâ‡∏≤ 2: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢',14,y); y+=6;
      doc.autoTable({ startY:y, head:[['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤','‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°']], body: md.sellTransactions.map(t=>[t.date,t.customer,t.items.map(i=>`${i.productName} (${i.quantity})`).join(', '),formatCurrency(t.total)]) });
      // Page 3: ‡∏™‡∏£‡∏∏‡∏õ
      doc.addPage(); y=20; doc.setFontSize(14); doc.text('‡∏´‡∏ô‡πâ‡∏≤ 3: ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î',14,y); y+=8;
      doc.setFontSize(12);
      doc.text(`‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°: ${formatCurrency(md.totalBuy)}`,14,y); y+=6;
      doc.text(`‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ${formatCurrency(md.totalSell)}`,14,y); y+=6;
      doc.text(`VAT ‡∏£‡∏ß‡∏°: ${formatCurrency(md.totalVat)}`,14,y); y+=6;
      doc.text(`‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°: ${formatCurrency(md.profit)}`,14,y);
      doc.save(`‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô_${month.replace('-','_')}.pdf`);
    }

    /* ========= Add/Edit product & misc ========= */
    document.getElementById('addStoreBtn').addEventListener('click',()=>{ const n=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô:'); if(n && !stores.includes(n)){ stores.push(n); saveToStorage(); updateStoreDropdowns(); }});
    document.getElementById('addCustomerBtn').addEventListener('click',()=>{ const n=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:'); if(n && !customers.includes(n)){ customers.push(n); saveToStorage(); updateCustomerDropdowns(); }});
    document.getElementById('addCategoryBtn').addEventListener('click',()=>{ const n=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:'); if(n && !categories.includes(n)){ categories.push(n); saveToStorage(); updateCategoryDropdowns(); }});

    document.getElementById('addProductBtn').addEventListener('click',()=>document.getElementById('productForm').classList.remove('hidden'));
    document.getElementById('cancelProductBtn').addEventListener('click',()=>{ document.getElementById('productForm').classList.add('hidden'); document.getElementById('addProductForm').reset(); });
    document.getElementById('addProductForm').addEventListener('submit',e=>{
      e.preventDefault();
      const product={ id:Date.now(), name:productName.value, category:productCategory.value, buyPrice:parseFloat(productBuyPrice.value), sellPrice:parseFloat(productSellPrice.value), hasVat:productHasVat.checked };
      products.push(product); saveToStorage(); updateProductsTable(); updateProductDropdowns();
      document.getElementById('productForm').classList.add('hidden'); e.target.reset(); syncNow('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
    });

    /* ========= Init ========= */
    function init(){
      document.getElementById('buyDate').value=new Date().toISOString().split('T')[0];
      document.getElementById('sellDate').value=new Date().toISOString().split('T')[0];
      const input=document.getElementById('scriptUrl'); const saved=localStorage.getItem('scriptUrl'); if(saved) input.value=saved;
      updateStoreDropdowns(); updateCustomerDropdowns(); updateCategoryDropdowns(); updateProductDropdowns(); updateProductsTable(); updateSummary();
    }
    init();
  </script>
</body>
</html>