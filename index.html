<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Plug2Plug POS ‚Äî Final</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:'Sarabun',sans-serif;background:linear-gradient(135deg,#1e1b4b 0%,#7c2d12 25%,#1e40af 50%,#991b1b 75%,#1e1b4b 100%);background-size:400% 400%;animation:grad 15s ease infinite}
  @keyframes grad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .tab-content{display:none}.tab-content.active{display:block}
  .glass{background:rgba(255,255,255,.08);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.18)}
  .dark-glass{background:rgba(0,0,0,.3);backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.1)}
  .badge{padding:.15rem .5rem;border-radius:.75rem;font-size:.75rem;border:1px solid}
  .input-error{outline:2px solid #ef4444;border-color:#ef4444!important}
</style>
</head>
<body class="min-h-screen text-white">
<div class="container mx-auto px-4 py-8 max-w-7xl">
  <div class="text-center mb-8">
    <h1 class="text-5xl font-bold mb-2">üè™ Plug2Plug POS</h1>
    <p class="text-gray-200">‡∏Ñ‡∏£‡∏ö‚Äî‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠/‡∏Ç‡∏≤‡∏¢/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Ä¢ Autosync Google Sheets ‚Ä¢ PDF 3 ‡∏´‡∏ô‡πâ‡∏≤</p>
  </div>

  <div class="dark-glass rounded-xl shadow-2xl mb-6">
    <div class="flex flex-wrap border-b border-gray-600">
      <button class="tab-btn px-6 py-4 font-medium text-blue-400 border-b-2 border-blue-400" data-tab="buy">üõí ‡∏ã‡∏∑‡πâ‡∏≠</button>
      <button class="tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white" data-tab="sell">üí∞ ‡∏Ç‡∏≤‡∏¢</button>
      <button class="tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white" data-tab="products">üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      <button class="tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white" data-tab="summary">üìä ‡∏™‡∏£‡∏∏‡∏õ</button>
      <button class="tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white" data-tab="reports">üìÑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
    </div>
    <div class="p-4 flex flex-col md:flex-row gap-3 items-start md:items-center">
      <div class="flex-1 w-full">
        <label class="block text-sm text-gray-300 mb-1">Google Apps Script URL (Web App /exec)</label>
        <input id="scriptUrl" type="url" placeholder="https://script.google.com/macros/s/XXXX/exec" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg">
      </div>
      <div class="flex gap-2">
        <button id="setupSheetsBtn" class="px-3 py-2 bg-slate-700 rounded-lg">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
        <button id="loadFromSheetsBtn" class="px-3 py-2 bg-purple-600 rounded-lg">üì• ‡πÇ‡∏´‡∏•‡∏î</button>
        <button id="syncToSheetsBtn" class="px-3 py-2 bg-indigo-600 rounded-lg">üìä ‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏µ‡∏ï</button>
      </div>
      <div id="syncStatus" class="text-sm text-gray-300">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
    </div>
  </div>

  <!-- BUY -->
  <div id="buy" class="tab-content active">
    <div class="dark-glass rounded-xl p-6">
      <h2 class="text-2xl font-bold mb-6">üõí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</h2>
      <form id="buyForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div><label class="block text-sm mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="buyDate" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required></div>
          <div>
            <label class="block text-sm mb-1">‡∏£‡πâ‡∏≤‡∏ô</label>
            <div class="flex gap-2">
              <select id="buyStore" class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô</option></select>
              <button type="button" id="addStoreBtn" class="px-4 py-2 bg-emerald-600 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô</button>
            </div>
          </div>
        </div>
        <div class="border-t border-gray-600 pt-6">
          <div id="buyItems">
            <div class="buy-item grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 glass rounded-lg border border-gray-600">
              <div><label class="block text-sm mb-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><select class="product-select w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option></select></div>
              <div><label class="block text-sm mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input type="number" class="quantity-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" min="1" value="1" required></div>
              <div><label class="block text-sm mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)</label><input type="number" class="price-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" step="0.01" min="0" required></div>
              <div class="flex items-end"><button type="button" class="remove-item w-full px-3 py-2 bg-red-600 rounded-lg">‡∏•‡∏ö</button></div>
            </div>
          </div>
          <button type="button" id="addBuyItem" class="mb-4 px-4 py-2 bg-blue-600 rounded-lg">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>
        <div class="flex justify-end"><button type="submit" class="px-8 py-3 bg-black rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</button></div>
      </form>
    </div>
  </div>

  <!-- SELL -->
  <div id="sell" class="tab-content">
    <div class="dark-glass rounded-xl p-6">
      <h2 class="text-2xl font-bold mb-6">üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>
      <form id="sellForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div><label class="block text-sm mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="sellDate" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required></div>
          <div>
            <label class="block text-sm mb-1">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
            <div class="flex gap-2">
              <select id="sellCustomer" class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option></select>
              <button type="button" id="addCustomerBtn" class="px-4 py-2 bg-emerald-600 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
            </div>
          </div>
        </div>
        <div class="border-t border-gray-600 pt-6">
          <div id="sellItems">
            <div class="sell-item grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 glass rounded-lg border border-gray-600">
              <div><label class="block text-sm mb-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><select class="product-select w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option></select></div>
              <div><label class="block text-sm mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input type="number" class="quantity-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" min="1" value="1" required></div>
              <div><label class="block text-sm mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ø)</label><input type="number" class="price-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" step="0.01" min="0" required></div>
              <div class="flex items-end"><button type="button" class="remove-item w-full px-3 py-2 bg-red-600 rounded-lg">‡∏•‡∏ö</button></div>
            </div>
          </div>
          <button type="button" id="addSellItem" class="mb-4 px-4 py-2 bg-blue-600 rounded-lg">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>
        <div class="flex justify-end"><button type="submit" class="px-8 py-3 bg-black rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button></div>
      </form>
    </div>
  </div>

  <!-- PRODUCTS -->
  <div id="products" class="tab-content">
    <div class="dark-glass rounded-xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
        <button id="addProductBtn" class="px-4 py-2 bg-blue-600 rounded-lg">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </div>
      <div id="productForm" class="hidden mb-6 p-4 dark-glass rounded-lg">
        <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
        <form id="addProductForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div><label class="block text-sm mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input id="productName" type="text" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required></div>
          <div>
            <label class="block text-sm mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
            <div class="flex gap-2">
              <select id="productCategory" class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required>
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                <option>‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option><option>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option><option>‡∏Ç‡∏ô‡∏°</option><option>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
              </select>
              <button type="button" id="addCategoryBtn" class="px-4 py-2 bg-purple-600 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î</button>
            </div>
          </div>
          <div><label class="block text-sm mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ø)</label><input id="productBuyPrice" type="number" step="0.01" min="0" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required></div>
          <div><label class="block text-sm mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ø)</label><input id="productSellPrice" type="number" step="0.01" min="0" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required></div>
          <div class="flex items-center"><input id="productHasVat" type="checkbox" class="mr-2"><label for="productHasVat" class="text-sm">‡∏°‡∏µ VAT 7%</label></div>
          <div class="flex gap-2"><button type="submit" class="px-4 py-2 bg-emerald-600 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button type="button" id="cancelProductBtn" class="px-4 py-2 bg-gray-700 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>
        </form>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead><tr class="border-b border-gray-600"><th class="text-left py-3 px-4">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="text-left py-3 px-4">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th class="text-left py-3 px-4">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠</th><th class="text-left py-3 px-4">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th><th class="text-left py-3 px-4">VAT</th><th class="text-left py-3 px-4">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° VAT</th><th class="text-left py-3 px-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
          <tbody id="productsTable"><tr><td colspan="7" class="text-center py-8 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- REPORTS -->
  <div id="reports" class="tab-content">
    <div class="dark-glass rounded-xl p-6 space-y-6">
      <div>
        <h2 class="text-2xl font-bold mb-6">üìÑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
          <div><label class="block text-sm mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input type="month" id="reportMonth" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg"></div>
          <div class="flex items-end gap-2">
            <button id="generatePDFBtn" class="px-6 py-2 bg-pink-600 rounded-lg">üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF</button>
            <span class="badge text-gray-300 border-gray-500">‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô / ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á</span>
          </div>
        </div>
        <div id="syncStatus2" class="text-sm text-gray-300">‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡∏•‡πà‡∏° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
      </div>
      <div>
        <h3 class="text-lg font-semibold mb-4">üìä ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
        <div id="monthlyPreview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="glass p-4 rounded text-center"><div class="text-2xl font-bold text-blue-400" id="totalBuyAmount">‡∏ø0</div><div class="text-sm text-gray-300">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°</div></div>
          <div class="glass p-4 rounded text-center"><div class="text-2xl font-bold text-green-400" id="totalSellAmount">‡∏ø0</div><div class="text-sm text-gray-300">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div></div>
          <div class="glass p-4 rounded text-center"><div class="text-2xl font-bold text-red-400" id="totalVatAmount">‡∏ø0</div><div class="text-sm text-gray-300">VAT ‡∏£‡∏ß‡∏°</div></div>
          <div class="glass p-4 rounded text-center"><div class="text-2xl font-bold text-yellow-400" id="totalProfit">‡∏ø0</div><div class="text-sm text-gray-300">‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SUMMARY -->
  <div id="summary" class="tab-content">
    <div class="dark-glass rounded-xl p-6 space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="glass p-4 rounded">
          <h3 class="text-lg font-semibold mb-3">‚úÖ ‡∏°‡∏µ VAT</h3>
          <div class="space-y-2">
            <div class="flex justify-between"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</span><span id="vatItemsCount" class="font-semibold">0</span></div>
            <div class="flex justify-between"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT):</span><span id="vatSubtotal" class="font-semibold">‡∏ø0</span></div>
            <div class="flex justify-between"><span>VAT 7%:</span><span id="vatAmount" class="font-semibold text-red-400">‡∏ø0</span></div>
            <div class="flex justify-between border-t border-gray-600 pt-2"><span class="font-medium">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏£‡∏ß‡∏° VAT):</span><span id="vatTotal" class="font-bold text-green-400">‡∏ø0</span></div>
          </div>
        </div>
        <div class="glass p-4 rounded">
          <h3 class="text-lg font-semibold mb-3">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ VAT</h3>
          <div class="space-y-2">
            <div class="flex justify-between"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</span><span id="noVatItemsCount" class="font-semibold">0</span></div>
            <div class="flex justify-between border-t border-gray-600 pt-2"><span class="font-medium">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span><span id="noVatTotal" class="font-bold text-blue-400">‡∏ø0</span></div>
          </div>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass p-4 rounded">
          <h3 class="text-lg font-semibold mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏°‡∏µ VAT</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead><tr class="border-b border-gray-600"><th class="text-left py-2 px-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="text-left py-2 px-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="text-left py-2 px-2">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th class="text-left py-2 px-2">‡∏£‡∏ß‡∏°</th></tr></thead>
              <tbody id="vatItemsList"><tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr></tbody>
            </table>
          </div>
        </div>
        <div class="glass p-4 rounded">
          <h3 class="text-lg font-semibold mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ VAT</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead><tr class="border-b border-gray-600"><th class="text-left py-2 px-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="text-left py-2 px-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="text-left py-2 px-2">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th class="text-left py-2 px-2">‡∏£‡∏ß‡∏°</th></tr></thead>
              <tbody id="noVatItemsList"><tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/* ===== Local storage ===== */
let products = JSON.parse(localStorage.getItem('products')) || [];
let stores = JSON.parse(localStorage.getItem('stores')) || ['‡πÄ‡∏ã‡πÄ‡∏ß‡πà‡∏ô','‡πÇ‡∏•‡∏ï‡∏±‡∏™','‡∏ö‡∏¥‡πä‡∏Å‡∏ã‡∏µ','‡πÅ‡∏°‡πá‡∏Ñ‡πÇ‡∏Ñ‡∏£'];
let customers = JSON.parse(localStorage.getItem('customers')) || ['‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'];
let categories = JSON.parse(localStorage.getItem('categories')) || ['‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°','‡∏Ç‡∏ô‡∏°','‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ','‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];
let buyTransactions = JSON.parse(localStorage.getItem('buyTransactions')) || [];
let sellTransactions = JSON.parse(localStorage.getItem('sellTransactions')) || [];
function saveToStorage(){ localStorage.setItem('products',JSON.stringify(products)); localStorage.setItem('stores',JSON.stringify(stores)); localStorage.setItem('customers',JSON.stringify(customers)); localStorage.setItem('categories',JSON.stringify(categories)); localStorage.setItem('buyTransactions',JSON.stringify(buyTransactions)); localStorage.setItem('sellTransactions',JSON.stringify(sellTransactions)); }
function formatCurrency(n){ return new Intl.NumberFormat('th-TH',{style:'currency',currency:'THB'}).format(n||0); }

/* ===== ID helpers ===== */
const uid = (prefix='') => prefix + Math.random().toString(36).slice(2,8) + Date.now().toString(36);
const sid = v => String(v ?? '');

/* ===== Tabs ===== */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const tab=btn.dataset.tab;
    document.querySelectorAll('.tab-btn').forEach(b=>b.className='tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white');
    btn.className='tab-btn px-6 py-4 font-medium '+(tab==='reports'?'text-red-400 border-b-2 border-red-400':'text-blue-400 border-b-2 border-blue-400');
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    if(tab==='summary') updateSummary();
    if(tab==='reports'){ updateMonthlyPreview(); const now=new Date(); document.getElementById('reportMonth').value=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; }
  });
});

/* ===== Dropdowns & Tables ===== */
function updateStoreDropdowns(){ const s=document.getElementById('buyStore'); s.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô</option>'+stores.map(v=>`<option>${v}</option>`).join(''); }
function ensureDefaultCustomer(){ if(!customers.includes('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ')) customers=['‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',...customers]; }
function updateCustomerDropdowns(){ ensureDefaultCustomer(); const s=document.getElementById('sellCustomer'); const cur=s.value; s.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>'+customers.map(v=>`<option>${v}</option>`).join(''); s.value=cur||'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'; }
function updateCategoryDropdowns(){ const sel=document.getElementById('productCategory'); const cur=sel.value; sel.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>'+categories.map(v=>`<option>${v}</option>`).join(''); sel.value=cur; }
function updateProductDropdowns(){ document.querySelectorAll('.product-select').forEach(sel=>{ const cur=sid(sel.value); sel.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>'+products.map(p=>`<option value="${sid(p.id)}">${p.name}</option>`).join(''); sel.value=cur; }); }
function updateProductsTable(){
  const tbody=document.getElementById('productsTable');
  if(!products.length){ tbody.innerHTML='<tr><td colspan="7" class="text-center py-8 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>'; return; }
  tbody.innerHTML=products.map(p=>{
    const vatPrice=p.hasVat?p.sellPrice*1.07:p.sellPrice;
    return `<tr class="border-b border-gray-600">
      <td class="py-3 px-4">${p.name}</td><td class="py-3 px-4">${p.category}</td>
      <td class="py-3 px-4">${formatCurrency(p.buyPrice)}</td>
      <td class="py-3 px-4">${formatCurrency(p.sellPrice)}</td>
      <td class="py-3 px-4"><span class="badge ${p.hasVat?'text-green-300 border-green-500 bg-green-600/20':'text-gray-300 border-gray-500 bg-gray-600/20'}">${p.hasVat?'‡∏°‡∏µ VAT':'‡πÑ‡∏°‡πà‡∏°‡∏µ VAT'}</span></td>
      <td class="py-3 px-4 font-semibold">${formatCurrency(vatPrice)}</td>
      <td class="py-3 px-4"><button onclick="deleteProduct('${sid(p.id)}')" class="text-red-400 hover:text-red-300 text-sm">üóëÔ∏è ‡∏•‡∏ö</button></td>
    </tr>`;
  }).join('');
}
function deleteProduct(id){ if(!confirm('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?')) return; const key=sid(id); products=products.filter(p=>sid(p.id)!==key); saveToStorage(); updateProductsTable(); updateProductDropdowns(); syncNow('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'); }

/* ===== Add/Remove rows ===== */
function addBuyItem(){ const c=document.getElementById('buyItems'); const d=document.createElement('div'); d.className='buy-item grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 glass rounded-lg border border-gray-600'; d.innerHTML=`<div><label class="block text-sm mb-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><select class="product-select w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option></select></div><div><label class="block text-sm mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input type="number" class="quantity-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" min="1" value="1" required></div><div><label class="block text-sm mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)</label><input type="number" class="price-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" step="0.01" min="0" required></div><div class="flex items-end"><button type="button" class="remove-item w-full px-3 py-2 bg-red-600 rounded-lg">‡∏•‡∏ö</button></div>`; c.appendChild(d); updateProductDropdowns(); }
function addSellItem(){ const c=document.getElementById('sellItems'); const d=document.createElement('div'); d.className='sell-item grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 glass rounded-lg border border-gray-600'; d.innerHTML=`<div><label class="block text-sm mb-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><select class="product-select w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option></select></div><div><label class="block text-sm mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input type="number" class="quantity-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" min="1" value="1" required></div><div><label class="block text-sm mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ø)</label><input type="number" class="price-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" step="0.01" min="0" required></div><div class="flex items-end"><button type="button" class="remove-item w-full px-3 py-2 bg-red-600 rounded-lg">‡∏•‡∏ö</button></div>`; c.appendChild(d); updateProductDropdowns(); }
document.getElementById('addBuyItem').addEventListener('click',addBuyItem);
document.getElementById('addSellItem').addEventListener('click',addSellItem);
document.addEventListener('click',e=>{ if(e.target.classList.contains('remove-item')){ const row=e.target.closest('.buy-item,.sell-item'); const box=row.parentElement; if(box.children.length>1) row.remove(); else alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); }});
document.addEventListener('change',e=>{
  if(e.target.classList.contains('product-select')){
    const pid=sid(e.target.value); const prod=products.find(p=>sid(p.id)===pid);
    if(prod){ const row=e.target.closest('.buy-item,.sell-item'); const price=row.querySelector('.price-input'); price.value=row.classList.contains('buy-item')?prod.buyPrice:prod.sellPrice; }
  }
});

/* ===== Buttons: add master data ===== */
document.getElementById('addStoreBtn').addEventListener('click',()=>{ const n=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô:'); if(n && !stores.includes(n)){ stores.push(n); saveToStorage(); updateStoreDropdowns(); }});
document.getElementById('addCustomerBtn').addEventListener('click',()=>{ const n=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:'); if(n && !customers.includes(n)){ customers.push(n); saveToStorage(); updateCustomerDropdowns(); }});
document.getElementById('addCategoryBtn').addEventListener('click',()=>{ const n=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:'); if(n && !categories.includes(n)){ categories.push(n); saveToStorage(); updateCategoryDropdowns(); }});
document.getElementById('addProductBtn').addEventListener('click',()=>document.getElementById('productForm').classList.remove('hidden'));
document.getElementById('cancelProductBtn').addEventListener('click',()=>{ document.getElementById('productForm').classList.add('hidden'); document.getElementById('addProductForm').reset(); });

/* ===== Add product ===== */
document.getElementById('addProductForm').addEventListener('submit',e=>{
  e.preventDefault();
  const product = { id: uid('p_'), name: productName.value, category: productCategory.value, buyPrice: parseFloat(productBuyPrice.value), sellPrice: parseFloat(productSellPrice.value), hasVat: productHasVat.checked };
  products.push(product); saveToStorage(); updateProductsTable(); updateProductDropdowns();
  document.getElementById('productForm').classList.add('hidden'); e.target.reset();
  syncNow('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
});

/* ===== Validation & submit ===== */
function validateLineItems(containerSelector){
  const rows=[...document.querySelectorAll(containerSelector+' .buy-item, '+containerSelector+' .sell-item')];
  let ok=true, msgs=[];
  rows.forEach(row=>{
    const sel=row.querySelector('.product-select'), qty=row.querySelector('.quantity-input'), price=row.querySelector('.price-input');
    [sel,qty,price].forEach(x=>x&&x.classList.remove('input-error'));
    const pid=sid(sel?.value), q=Number(qty?.value), p=Number(price?.value);
    if(!pid || !products.find(pr=>sid(pr.id)===pid)){ ok=false; sel?.classList.add('input-error'); }
    if(!(q>0)){ ok=false; qty?.classList.add('input-error'); }
    if(!(p>=0)){ ok=false; price?.classList.add('input-error'); }
  });
  if(!ok) msgs.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô>0 + ‡∏£‡∏≤‡∏Ñ‡∏≤>=0 ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î');
  return {ok, message: msgs.join('\n')};
}

document.getElementById('buyForm').addEventListener('submit',async e=>{
  e.preventDefault(); const v=validateLineItems('#buyItems'); if(!v.ok) return alert(v.message);
  const date=buyDate.value, store=buyStore.value; if(!store) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô');
  const items=[]; document.querySelectorAll('.buy-item').forEach(r=>{ const pid=sid(r.querySelector('.product-select').value), q=Number(r.querySelector('.quantity-input').value), p=Number(r.querySelector('.price-input').value); const prod=products.find(x=>sid(x.id)===pid); if(pid && prod && q>0 && p>=0){ items.push({productId:pid,productName:prod.name,quantity:q,price:p,total:q*p,hasVat:!!prod.hasVat}); }});
  if(!items.length) return alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
  const tid=uid('buy_'); buyTransactions.push({id:tid,date,store,items,total:items.reduce((s,i)=>s+i.total,0)});
  saveToStorage(); await syncNow('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠'); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
  e.target.reset(); buyDate.value=new Date().toISOString().split('T')[0]; document.getElementById('buyItems').innerHTML=''; addBuyItem(); updateProductDropdowns();
});

document.getElementById('sellForm').addEventListener('submit',async e=>{
  e.preventDefault(); const v=validateLineItems('#sellItems'); if(!v.ok) return alert(v.message);
  const date=sellDate.value, customer=sellCustomer.value||'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
  const items=[]; document.querySelectorAll('.sell-item').forEach(r=>{ const pid=sid(r.querySelector('.product-select').value), q=Number(r.querySelector('.quantity-input').value), p=Number(r.querySelector('.price-input').value); const prod=products.find(x=>sid(x.id)===pid); if(pid && prod && q>0 && p>=0){ items.push({productId:pid,productName:prod.name,quantity:q,price:p,total:q*p,hasVat:!!prod.hasVat}); }});
  if(!items.length) return alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
  const tid=uid('sell_'); sellTransactions.push({id:tid,date,customer,items,total:items.reduce((s,i)=>s+i.total,0)});
  saveToStorage(); await syncNow('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≤‡∏¢'); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
  e.target.reset(); sellDate.value=new Date().toISOString().split('T')[0]; document.getElementById('sellItems').innerHTML=''; addSellItem(); updateProductDropdowns(); updateCustomerDropdowns();
});

/* ===== Summary & Preview ===== */
function updateSummary(){
  const all=[]; buyTransactions.forEach(t=>t.items.forEach(i=>all.push(i))); sellTransactions.forEach(t=>t.items.forEach(i=>all.push(i)));
  const vat=all.filter(i=>i.hasVat), novat=all.filter(i=>!i.hasVat);
  const vsub=vat.reduce((s,i)=>s+i.total,0), v7=vsub*0.07, vtot=vsub+v7, ntot=novat.reduce((s,i)=>s+i.total,0);
  vatItemsCount.textContent=vat.length; vatSubtotal.textContent=formatCurrency(vsub); vatAmount.textContent=formatCurrency(v7); vatTotal.textContent=formatCurrency(vtot); noVatItemsCount.textContent=novat.length; noVatTotal.textContent=formatCurrency(ntot);
  const tbodyV=document.getElementById('vatItemsList'), tbodyN=document.getElementById('noVatItemsList');
  tbodyV.innerHTML = vat.length? vat.map(i=>`<tr class="border-b border-gray-600"><td class="py-2 px-2">${i.productName}</td><td class="py-2 px-2">${i.quantity}</td><td class="py-2 px-2">${formatCurrency(i.price)}</td><td class="py-2 px-2 font-semibold">${formatCurrency(i.total)}</td></tr>`).join('') : '<tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
  tbodyN.innerHTML = novat.length? novat.map(i=>`<tr class="border-b border-gray-600"><td class="py-2 px-2">${i.productName}</td><td class="py-2 px-2">${i.quantity}</td><td class="py-2 px-2">${formatCurrency(i.price)}</td><td class="py-2 px-2 font-semibold">${formatCurrency(i.total)}</td></tr>`).join('') : '<tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
}
function getMonthlyData(month){
  const [Y,M]=month.split('-');
  const filt=t=>{ const d=new Date(t.date); return d.getFullYear()==Y && (d.getMonth()+1)==Number(M); };
  const mb=buyTransactions.filter(filt), ms=sellTransactions.filter(filt);
  const all=[]; mb.forEach(t=>all.push(...t.items)); ms.forEach(t=>all.push(...t.items));
  const vat=all.filter(i=>i.hasVat);
  const totalBuy=mb.reduce((s,t)=>s+t.total,0), totalSell=ms.reduce((s,t)=>s+t.total,0), totalVat=vat.reduce((s,i)=>s+i.total*0.07,0);
  return {buyTransactions:mb, sellTransactions:ms, vatItems:vat, totalBuy, totalSell, totalVat, profit: totalSell-totalBuy};
}
function updateMonthlyPreview(){
  const now=new Date(); const m=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const md=getMonthlyData(m);
  totalBuyAmount.textContent=formatCurrency(md.totalBuy); totalSellAmount.textContent=formatCurrency(md.totalSell); totalVatAmount.textContent=formatCurrency(md.totalVat); totalProfit.textContent=formatCurrency(md.profit);
}

/* ===== PDF Fallback (client) ===== */
function generateMonthlyPDF(month){
  const { jsPDF }=window.jspdf; const doc=new jsPDF(); doc.setFont('helvetica');
  doc.setFontSize(20); doc.text('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',105,18,{align:'center'}); doc.setFontSize(12); doc.text(`‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${month}`,105,26,{align:'center'});
  const md=getMonthlyData(month); let y=34;
  doc.setFontSize(14); doc.text('‡∏´‡∏ô‡πâ‡∏≤ 1: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠',14,y); y+=6;
  doc.autoTable({ startY:y, head:[['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏£‡πâ‡∏≤‡∏ô','‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°']], body: md.buyTransactions.map(t=>[t.date,t.store,t.items.map(i=>`${i.productName} (${i.quantity})`).join(', '),formatCurrency(t.total)]) });
  doc.addPage(); y=20; doc.setFontSize(14); doc.text('‡∏´‡∏ô‡πâ‡∏≤ 2: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢',14,y); y+=6;
  doc.autoTable({ startY:y, head:[['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤','‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°']], body: md.sellTransactions.map(t=>[t.date,t.customer,t.items.map(i=>`${i.productName} (${i.quantity})`).join(', '),formatCurrency(t.total)]) });
  doc.addPage(); y=20; doc.setFontSize(14); doc.text('‡∏´‡∏ô‡πâ‡∏≤ 3: ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î',14,y); y+=8;
  doc.setFontSize(12); doc.text(`‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°: ${formatCurrency(md.totalBuy)}`,14,y); y+=6; doc.text(`‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ${formatCurrency(md.totalSell)}`,14,y); y+=6; doc.text(`VAT ‡∏£‡∏ß‡∏°: ${formatCurrency(md.totalVat)}`,14,y); y+=6; doc.text(`‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°: ${formatCurrency(md.profit)}`,14,y);
  doc.save(`‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô_${month.replace('-','_')}.pdf`);
}

/* ===== Network helpers ===== */
const getScriptUrl = ()=> (document.getElementById('scriptUrl')?.value || localStorage.getItem('scriptUrl') || '').trim();
const rememberScriptUrl = ()=>{ const u=getScriptUrl(); if(u) localStorage.setItem('scriptUrl',u); };
function setSyncStatus(msg,color='text-gray-300'){ const el=document.getElementById('syncStatus'); if(el){ el.textContent=msg; el.className=`text-sm ${color}`; } const el2=document.getElementById('syncStatus2'); if(el2 && color.includes('green')){ el2.textContent=msg; el2.className=`text-sm ${color}`; } }
function errorToString(err){ return (err?.name||'Error')+(err?.message?': '+err.message:''); }

async function httpJson(url, {method='GET', headers={}, body=null, timeoutMs=12000}={}, retries=1){
  for(let a=0;a<=retries;a++){
    const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const res=await fetch(url,{method,headers,body,signal:ctrl.signal});
      clearTimeout(t);
      const text=await res.text(); let data={}; try{ data=text?JSON.parse(text):{} }catch(_){}
      if(!res.ok) throw new Error((data&&data.error)||text||`HTTP ${res.status}`);
      return data;
    }catch(err){
      clearTimeout(t);
      if(a===retries) throw err;
      await new Promise(r=>setTimeout(r,600*(a+1)));
    }
  }
}
async function postPlainJson(url, obj){
  return httpJson(url, { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(obj), timeoutMs:15000 }, 2);
}

/* ===== Sync & actions ===== */
async function ping(u){ return httpJson(u,{method:'GET',timeoutMs:6000},1); }
async function syncNow(reason='auto'){
  const u=getScriptUrl(); if(!u) { setSyncStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà Apps Script URL','text-red-400'); return {ok:false}; }
  setSyncStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (${reason})...`,'text-yellow-400');
  const payload={ products, buyTransactions, sellTransactions, stores, customers, categories, timestamp:new Date().toISOString() };
  try{
    await ping(u);
    const data=await postPlainJson(u,payload);
    if(data?.ok){ setSyncStatus(`‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${reason})`,'text-green-400'); return {ok:true}; }
    setSyncStatus(`‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data?.error||'unknown'}`,'text-red-400'); return {ok:false};
  }catch(err){
    console.error('[SYNC FAIL]',errorToString(err),payload);
    setSyncStatus('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+errorToString(err),'text-red-400'); return {ok:false};
  }
}

document.getElementById('setupSheetsBtn').addEventListener('click', async ()=>{
  try{
    const u=getScriptUrl(); if(!u) return alert('‡πÉ‡∏™‡πà Apps Script URL ‡∏Å‡πà‡∏≠‡∏ô');
    rememberScriptUrl(); setSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤...','text-yellow-400');
    const r=await httpJson(`${u}?action=setup`,{method:'GET',timeoutMs:12000},1);
    if(r?.ok) setSyncStatus('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à!','text-green-400'); else setSyncStatus('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','text-red-400');
  }catch(e){ setSyncStatus('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+errorToString(e),'text-red-400'); }
});
document.getElementById('loadFromSheetsBtn').addEventListener('click', async ()=>{
  try{
    const u=getScriptUrl(); if(!u) return alert('‡πÉ‡∏™‡πà Apps Script URL ‡∏Å‡πà‡∏≠‡∏ô');
    rememberScriptUrl(); setSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...','text-yellow-400');
    const d=await httpJson(`${u}?action=load`,{method:'GET',timeoutMs:15000},2);
    if(d.products) products=d.products; if(d.buyTransactions) buyTransactions=d.buyTransactions; if(d.sellTransactions) sellTransactions=d.sellTransactions; if(d.stores) stores=d.stores; if(d.customers) customers=d.customers; if(d.categories) categories=d.categories;
    saveToStorage(); init(); setSyncStatus('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!','text-green-400');
  }catch(e){ setSyncStatus('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+errorToString(e),'text-red-400'); }
});
document.getElementById('syncToSheetsBtn').addEventListener('click',()=>{ rememberScriptUrl(); syncNow('‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); });

document.getElementById('generatePDFBtn').addEventListener('click', async function(){
  const m=document.getElementById('reportMonth').value; if(!m) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô');
  const u=getScriptUrl(); try{ if(u){ const r=await httpJson(`${u}?action=pdf&month=${encodeURIComponent(m)}`,{method:'GET',timeoutMs:25000},1); if(r?.ok && (r.downloadUrl||r.url)){ window.open(r.downloadUrl||r.url,'_blank'); return; } } }catch(_){}
  generateMonthlyPDF(m); // fallback client
});

/* ===== Normalize old data & init ===== */
function normalizeProducts(){ let changed=false; products=(products||[]).map(p=>{ if(!p.id){ p.id=uid('p_'); changed=true; } p.id=sid(p.id); return p; }); if(changed) saveToStorage(); }
function init(){
  buyDate.value=new Date().toISOString().split('T')[0]; sellDate.value=new Date().toISOString().split('T')[0];
  const saved=localStorage.getItem('scriptUrl'); if(saved) document.getElementById('scriptUrl').value=saved;
  normalizeProducts();
  updateStoreDropdowns(); updateCustomerDropdowns(); updateCategoryDropdowns(); updateProductDropdowns(); updateProductsTable(); updateSummary();
}
init();
</script>
</body>
</html>
