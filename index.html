<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Plug2Plug POS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
    body{font-family:'Sarabun',sans-serif;background:#0b1020;color:#e6e6e6}
    .dark-glass{background:rgba(0,0,0,.35);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.08);border-radius:12px}
    .neon{box-shadow:0 0 16px rgba(59,130,246,.35)}
    .btn{border-radius:10px}
    .grid-head th{font-weight:600}
    .chip{padding:.15rem .5rem;border-radius:999px;border:1px solid rgba(255,255,255,.2)}
    .hidden{display:none}
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto max-w-7xl p-4 md:p-8">
    <header class="text-center mb-6">
      <h1 class="text-3xl md:text-4xl font-bold">üè™ Plug2Plug POS</h1>
      <p class="text-gray-300">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠-‡∏Ç‡∏≤‡∏¢ / ‡∏™‡∏ï‡πá‡∏≠‡∏Å / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF / ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤-‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</p>
    </header>

    <!-- Tabs -->
    <div class="dark-glass p-1 mb-5 flex gap-2">
      <button class="tab px-4 py-2 bg-blue-600 text-white btn" data-tab="buy">üõí ‡∏ã‡∏∑‡πâ‡∏≠</button>
      <button class="tab px-4 py-2 hover:bg-blue-600/20 btn" data-tab="sell">üí∞ ‡∏Ç‡∏≤‡∏¢</button>
      <button class="tab px-4 py-2 hover:bg-blue-600/20 btn" data-tab="products">üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      <button class="tab px-4 py-2 hover:bg-blue-600/20 btn" data-tab="summary">üìä ‡∏™‡∏£‡∏∏‡∏õ</button>
      <button class="tab px-4 py-2 hover:bg-blue-600/20 btn" data-tab="reports">üìÑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô/‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤-‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</button>
      <div class="ml-auto flex items-center gap-2 text-sm">
        <input id="scriptUrl" placeholder="https://script.google.com/macros/s/xxxxxxxx/exec" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded w-72" />
        <button id="btnSetup" class="px-3 py-2 bg-amber-600 text-white rounded btn">‚öôÔ∏è Setup</button>
        <button id="loadFromSheetsBtn" class="px-3 py-2 bg-sky-600 text-white rounded btn">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï</button>
      </div>
    </div>

    <!-- BUY -->
    <section id="buy" class="dark-glass p-4 md:p-6">
      <h2 class="text-xl font-semibold mb-4">üõí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</h2>
      <form id="buyForm" class="space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="buyDate" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded" required />
          </div>
          <div>
            <label class="text-sm text-gray-300">‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
            <div class="flex gap-2">
              <select id="buyStore" class="flex-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded">
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô</option>
              </select>
              <button type="button" id="addStoreBtn" class="px-3 py-2 bg-emerald-600 text-white rounded btn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô</button>
            </div>
          </div>
        </div>

        <div class="border-t border-gray-700 pt-4">
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
            <button type="button" id="addBuyItem" class="px-3 py-2 bg-blue-600 text-white rounded btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          </div>
          <div id="buyItems"></div>
        </div>

        <div class="text-right">
          <button type="submit" class="px-6 py-2 bg-neutral-900 hover:bg-neutral-800 text-white rounded btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</button>
        </div>
      </form>
    </section>

    <!-- SELL -->
    <section id="sell" class="dark-glass p-4 md:p-6 hidden">
      <h2 class="text-xl font-semibold mb-4">üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>
      <form id="sellForm" class="space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="sellDate" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded" required />
          </div>
          <div>
            <label class="text-sm text-gray-300">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
            <div class="flex gap-2">
              <select id="sellCustomer" class="flex-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded">
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>
                <option value="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
              </select>
              <button type="button" id="addCustomerBtn" class="px-3 py-2 bg-emerald-600 text-white rounded btn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
            </div>
          </div>
        </div>

        <div class="border-t border-gray-700 pt-4">
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
            <button type="button" id="addSellItem" class="px-3 py-2 bg-blue-600 text-white rounded btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          </div>
          <div id="sellItems"></div>
        </div>

        <div class="text-right">
          <button type="submit" class="px-6 py-2 bg-neutral-900 hover:bg-neutral-800 text-white rounded btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
        </div>
      </form>
    </section>

    <!-- PRODUCTS -->
    <section id="products" class="dark-glass p-4 md:p-6 hidden">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-semibold">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
        <button id="addProductBtn" class="px-3 py-2 bg-blue-600 text-white rounded btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </div>

      <div id="productForm" class="hidden dark-glass p-4 mb-4">
        <h3 class="font-semibold mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
        <form id="addProductForm" class="grid md:grid-cols-3 gap-3">
          <input id="productName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded" required />
          <div class="flex gap-2">
            <select id="productCategory" class="flex-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded" required>
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
            </select>
            <button type="button" id="addCategoryBtn" class="px-3 py-2 bg-purple-600 text-white rounded btn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î</button>
          </div>
          <input type="number" id="productBuyPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠" step="0.01" min="0" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded" required />
          <input type="number" id="productSellPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢" step="0.01" min="0" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded" required />
          <label class="flex items-center gap-2">
            <input type="checkbox" id="productHasVat" />
            <span>‡∏°‡∏µ VAT 7%</span>
          </label>
          <div class="flex gap-2">
            <button class="px-3 py-2 bg-emerald-600 text-white rounded btn" type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="px-3 py-2 bg-neutral-700 text-white rounded btn" type="button" id="cancelProductBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </form>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="grid-head">
            <tr class="border-b border-gray-700">
              <th class="text-left py-2 px-2">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th class="text-left py-2 px-2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
              <th class="text-left py-2 px-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠</th>
              <th class="text-left py-2 px-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
              <th class="text-left py-2 px-2">VAT</th>
              <th class="text-left py-2 px-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° VAT</th>
              <th class="text-left py-2 px-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="productsTable">
            <tr><td colspan="7" class="text-center py-6 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- SUMMARY -->
    <section id="summary" class="dark-glass p-4 md:p-6 hidden">
      <div class="flex gap-3 items-end mb-4">
        <div>
          <label class="text-sm text-gray-300">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
          <input type="month" id="sumMonth" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded">
        </div>
        <button id="refreshSummary" class="px-3 py-2 bg-sky-600 text-white rounded btn">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏£‡∏∏‡∏õ</button>
      </div>
      <div id="summaryCards" class="grid md:grid-cols-4 gap-3 mb-4">
        <div class="dark-glass p-3 text-center"><div class="text-xs text-gray-400">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°</div><div id="sumTotalBuy" class="text-lg font-semibold">‡∏ø0</div></div>
        <div class="dark-glass p-3 text-center"><div class="text-xs text-gray-400">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div><div id="sumTotalSell" class="text-lg font-semibold">‡∏ø0</div></div>
        <div class="dark-glass p-3 text-center"><div class="text-xs text-gray-400">VAT ‡∏£‡∏ß‡∏°</div><div id="sumTotalVat" class="text-lg font-semibold">‡∏ø0</div></div>
        <div class="dark-glass p-3 text-center"><div class="text-xs text-gray-400">‡∏Å‡∏≥‡πÑ‡∏£</div><div id="sumProfit" class="text-lg font-semibold">‡∏ø0</div></div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="dark-glass p-3">
          <h3 class="font-semibold mb-2">‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏µ VAT</h3>
          <div class="text-sm text-gray-300 mb-2">
            ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <span id="vatItemsCount">0</span> | ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT): <span id="vatSubtotal">‡∏ø0</span> |
            VAT 7%: <span id="vatAmount">‡∏ø0</span> | ‡∏£‡∏ß‡∏° VAT: <span id="vatTotal">‡∏ø0</span>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead><tr class="border-b border-gray-700"><th class="py-1 text-left">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="py-1 text-left">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="py-1 text-left">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th class="py-1 text-left">‡∏£‡∏ß‡∏°</th></tr></thead>
              <tbody id="vatItemsList"><tr><td colspan="4" class="text-center py-3 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr></tbody>
            </table>
          </div>
        </div>

        <div class="dark-glass p-3">
          <h3 class="font-semibold mb-2">‚ùå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏°‡∏µ VAT</h3>
          <div class="text-sm text-gray-300 mb-2">
            ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <span id="noVatItemsCount">0</span> | ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span id="noVatTotal">‡∏ø0</span>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead><tr class="border-b border-gray-700"><th class="py-1 text-left">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="py-1 text-left">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="py-1 text-left">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th class="py-1 text-left">‡∏£‡∏ß‡∏°</th></tr></thead>
              <tbody id="noVatItemsList"><tr><td colspan="4" class="text-center py-3 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="reports" class="dark-glass p-4 md:p-6 hidden">
      <h2 class="text-xl font-semibold mb-3">üìÑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô / ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ä‡∏µ‡∏ï</h2>
      <div class="grid md:grid-cols-2 gap-3 mb-4">
        <div>
          <label class="text-sm text-gray-300">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
          <input type="month" id="reportMonth" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded" />
        </div>
        <div class="flex items-end gap-2">
          <button id="generatePDFBtn" class="px-4 py-2 bg-rose-600 text-white rounded btn">üìÑ PDF 3 ‡∏´‡∏ô‡πâ‡∏≤</button>
        </div>
      </div>

      <div class="dark-glass p-3 mb-4">
        <h3 class="font-semibold mb-2">üìë PDF ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏£‡πâ‡∏≤‡∏ô/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà, ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ VAT, ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</h3>
        <div class="flex flex-wrap gap-2 items-center">
          <select id="pdfMode" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white">
            <option value="buy">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</option>
            <option value="sell">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢</option>
          </select>
          <select id="pdfFilter" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white">
            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)</option>
            <option value="actor">‡∏ï‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>
            <option value="category">‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
            <option value="vat">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏µ VAT</option>
          </select>
          <input id="pdfActor" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡πâ‡∏≤‡∏ô/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å actor)" />
          <button id="exportCustomPdf" class="px-4 py-2 bg-pink-600 text-white rounded btn">üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </div>
      </div>

      <div class="dark-glass p-3">
        <h3 class="font-semibold mb-2">üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Google Sheets + Import/Export</h3>
        <div class="grid md:grid-cols-2 gap-3 mb-3">
          <div>
            <label class="text-sm text-gray-300">Google Apps Script URL</label>
            <input type="url" id="scriptUrl2" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded"
                   placeholder="https://script.google.com/macros/s/..." />
          </div>
          <div class="flex items-end gap-2">
            <button id="syncToSheetsBtn" class="px-3 py-2 bg-blue-600 text-white rounded btn">üì§ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏µ‡∏ï</button>
            <button id="exportJsonBtn" class="px-3 py-2 bg-indigo-600 text-white rounded btn">‚¨áÔ∏è Export JSON</button>
            <select id="exportCsvType" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white">
              <option value="Products">Products</option>
              <option value="Stores">Stores</option>
              <option value="Customers">Customers</option>
              <option value="Categories">Categories</option>
              <option value="Buys">Buys</option>
              <option value="BuyItems">BuyItems</option>
              <option value="Sells">Sells</option>
              <option value="SellItems">SellItems</option>
            </select>
            <button id="exportCsvBtn" class="px-3 py-2 bg-indigo-600 text-white rounded btn">‚¨áÔ∏è Export CSV</button>
          </div>
        </div>
        <div class="flex gap-2 mb-2">
          <input type="file" id="importJsonFile" accept="application/json" class="hidden" />
          <button id="importMergeBtn" class="px-3 py-2 bg-amber-600 text-white rounded btn">‚¨ÜÔ∏è Import (Merge)</button>
          <button id="importReplaceBtn" class="px-3 py-2 bg-rose-600 text-white rounded btn">‚ö†Ô∏è Import (Replace)</button>
        </div>
        <div id="syncStatus" class="text-sm text-gray-400"></div>
      </div>
    </section>
  </div>

  <!-- datalist ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
  <datalist id="productList"></datalist>

  <script>
  /* ====== STATE ====== */
  let products = JSON.parse(localStorage.getItem('products')||'[]');
  let stores = JSON.parse(localStorage.getItem('stores')||'[]');
  let customers = JSON.parse(localStorage.getItem('customers')||'[]');
  let categories = JSON.parse(localStorage.getItem('categories')||'[]');
  let buyTransactions = JSON.parse(localStorage.getItem('buyTransactions')||'[]');
  let sellTransactions = JSON.parse(localStorage.getItem('sellTransactions')||'[]');
  let inFlight = false;

  /* ====== Helpers ====== */
  function saveAll(){
    localStorage.setItem('products', JSON.stringify(products));
    localStorage.setItem('stores', JSON.stringify(stores));
    localStorage.setItem('customers', JSON.stringify(customers));
    localStorage.setItem('categories', JSON.stringify(categories));
    localStorage.setItem('buyTransactions', JSON.stringify(buyTransactions));
    localStorage.setItem('sellTransactions', JSON.stringify(sellTransactions));
  }
  function thb(n){ return new Intl.NumberFormat('th-TH',{style:'currency',currency:'THB'}).format(Number(n)||0); }
  function setSyncStatus(msg, cls){ const el=document.getElementById('syncStatus'); if(!el) return; el.textContent=msg; el.className='text-sm '+(cls||'text-gray-300');}
  function todayISO(){ return new Date().toISOString().slice(0,10); }

  function getScriptUrl(){
    const p1 = document.getElementById('scriptUrl')?.value?.trim();
    const p2 = document.getElementById('scriptUrl2')?.value?.trim();
    const v = p2 || p1 || localStorage.getItem('scriptUrl') || '';
    if (v && !document.getElementById('scriptUrl').value) document.getElementById('scriptUrl').value = v;
    if (v && !document.getElementById('scriptUrl2').value) document.getElementById('scriptUrl2').value = v;
    return v;
  }
  function rememberScriptUrl(){
    const v = getScriptUrl();
    if (v) localStorage.setItem('scriptUrl', v);
  }

  /* ====== Tabs ====== */
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll('.tab').forEach(b=> b.classList.remove('bg-blue-600','text-white'));
      btn.classList.add('bg-blue-600','text-white');
      document.querySelectorAll('section').forEach(s=> s.classList.add('hidden'));
      document.getElementById(btn.dataset.tab).classList.remove('hidden');
      if (btn.dataset.tab==='summary') refreshSummary();
      if (btn.dataset.tab==='reports'){
        const now = new Date(); document.getElementById('reportMonth').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      }
    };
  });

  /* ====== Dropdowns & Tables ====== */
  function refreshStores(){
    const sel=document.getElementById('buyStore'); sel.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô</option>';
    stores.forEach(s=> sel.innerHTML+=`<option value="${s}">${s}</option>`);
  }
  function refreshCustomers(){
    const sel=document.getElementById('sellCustomer'); sel.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option><option value="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>';
    customers.forEach(c=> sel.innerHTML+=`<option value="${c}">${c}</option>`);
  }
  function refreshCategories(){
    const sel=document.getElementById('productCategory'); sel.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>';
    categories.forEach(c=> sel.innerHTML+=`<option value="${c}">${c}</option>`);
  }
  function refreshProductsTable(){
    const tbody=document.getElementById('productsTable');
    if (!products.length){ tbody.innerHTML='<tr><td colspan="7" class="text-center py-6 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>'; return; }
    tbody.innerHTML = products.map(p=>{
      const vatPrice = p.hasVat ? (Number(p.sellPrice)*1.07) : Number(p.sellPrice);
      return `
      <tr class="border-b border-gray-700">
        <td class="py-2 px-2">${p.name}</td>
        <td class="py-2 px-2">${p.category||'-'}</td>
        <td class="py-2 px-2">${thb(p.buyPrice)}</td>
        <td class="py-2 px-2">${thb(p.sellPrice)}</td>
        <td class="py-2 px-2"><span class="chip ${p.hasVat?'border-emerald-500 text-emerald-300':'text-gray-300'}">${p.hasVat?'‡∏°‡∏µ VAT':'‡πÑ‡∏°‡πà‡∏°‡∏µ VAT'}</span></td>
        <td class="py-2 px-2 font-semibold">${thb(vatPrice)}</td>
        <td class="py-2 px-2"><button class="text-rose-400" onclick="deleteProduct('${p.id}')">‡∏•‡∏ö</button></td>
      </tr>`;
    }).join('');
  }

  /* ====== Datalist Autocomplete ====== */
  function rebuildDatalist(){
    const dl = document.getElementById('productList');
    dl.innerHTML = products.map(p=> `<option value="${p.name}" data-id="${p.id}"></option>`).join('');
  }

  function makeRow(containerId, type){ // type: 'buy'|'sell'
    const row = document.createElement('div');
    row.className = `${type}-item grid md:grid-cols-4 gap-3 p-3 mb-3 dark-glass`;
    row.innerHTML = `
      <div>
        <label class="text-sm text-gray-300">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
        <input list="productList" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." class="product-input w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white" />
        <input type="hidden" class="product-id"/>
      </div>
      <div>
        <label class="text-sm text-gray-300">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
        <input type="number" min="1" value="1" class="quantity-input w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded"/>
      </div>
      <div>
        <label class="text-sm text-gray-300">${type==='buy'?'‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)':'‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ø)'}</label>
        <input type="number" step="0.01" min="0" class="price-input w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded"/>
      </div>
      <div class="flex items-end">
        <button type="button" class="remove-item px-3 py-2 bg-rose-600 text-white rounded btn w-full">‡∏•‡∏ö</button>
      </div>`;
    document.getElementById(containerId).appendChild(row);
  }

  function hookRowEvents(){
    document.addEventListener('change', (e)=>{
      if (e.target && e.target.classList.contains('product-input')){
        const name = e.target.value.trim();
        const found = products.find(p=> p.name===name);
        const row = e.target.closest('.buy-item,.sell-item');
        const pidEl = row.querySelector('.product-id');
        const priceEl = row.querySelector('.price-input');
        if (found){
          pidEl.value = found.id;
          priceEl.value = row.classList.contains('buy-item') ? (found.buyPrice||0) : (found.sellPrice||0);
        }else{
          pidEl.value = '';
        }
      }
      if (e.target && e.target.classList.contains('remove-item')){
        const box = e.target.closest('.buy-item,.sell-item');
        const container = box.parentElement;
        if (container.querySelectorAll('.buy-item,.sell-item').length>1) box.remove();
      }
    });
  }

  /* ====== Submit: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏£‡∏±‡∏ß + sync ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ====== */
  function lock(btn){ inFlight=true; if (btn){ btn.disabled=true; btn.classList.add('opacity-60','cursor-not-allowed'); } }
  function unlock(btn){ inFlight=false; if (btn){ btn.disabled=false; btn.classList.remove('opacity-60','cursor-not-allowed'); } }

  async function syncNow(reason='manual'){
    const url = getScriptUrl(); if(!url) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Script URL'); return false; }
    rememberScriptUrl();
    const payload = { products, stores, customers, categories, buyTransactions, sellTransactions, timestamp:new Date().toISOString(), reason };
    try{
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload)});
      const text = await res.text(); let d; try{ d=JSON.parse(text);}catch(_){ d={ok:false,error:text}; }
      if (d.ok){ setSyncStatus('‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','text-emerald-400'); return true; }
      setSyncStatus('‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+(d.error||'unknown'),'text-rose-400'); return false;
    }catch(err){ setSyncStatus('‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+err,'text-rose-400'); return false; }
  }

  /* ====== BUY & SELL Handlers ====== */
  document.getElementById('addBuyItem').onclick = ()=> makeRow('buyItems','buy');
  document.getElementById('addSellItem').onclick = ()=> makeRow('sellItems','sell');

  document.getElementById('buyForm').addEventListener('submit', async function(e){
    e.preventDefault(); if (inFlight) return; const btn = this.querySelector('button[type="submit"]'); lock(btn);
    const date = document.getElementById('buyDate').value || todayISO();
    const store = document.getElementById('buyStore').value || '';
    const items = [];
    document.querySelectorAll('#buyItems .buy-item').forEach(row=>{
      const pid=row.querySelector('.product-id').value;
      const name=row.querySelector('.product-input').value.trim();
      const qty=Number(row.querySelector('.quantity-input').value)||0;
      const price=Number(row.querySelector('.price-input').value)||0;
      if (name && qty>0){
        const p = products.find(pp=> String(pp.id)===String(pid) || pp.name===name) || {hasVat:false};
        items.push({ productId: p.id||'', productName: name, quantity: qty, price, total: qty*price, hasVat: !!p.hasVat });
      }
    });
    if (!items.length){ unlock(btn); return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); }
    buyTransactions.push({ id: String(Date.now()), date, store, items, total: items.reduce((s,i)=>s+i.total,0) });
    saveAll();
    const ok = await syncNow('buy-submit');
    unlock(btn);
    if (ok){ alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); this.reset(); document.getElementById('buyDate').value=todayISO(); document.getElementById('buyItems').innerHTML=''; makeRow('buyItems','buy'); }
  });

  document.getElementById('sellForm').addEventListener('submit', async function(e){
    e.preventDefault(); if (inFlight) return; const btn = this.querySelector('button[type="submit"]'); lock(btn);
    const date = document.getElementById('sellDate').value || todayISO();
    const customer = document.getElementById('sellCustomer').value || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
    const items = [];
    document.querySelectorAll('#sellItems .sell-item').forEach(row=>{
      const pid=row.querySelector('.product-id').value;
      const name=row.querySelector('.product-input').value.trim();
      const qty=Number(row.querySelector('.quantity-input').value)||0;
      const price=Number(row.querySelector('.price-input').value)||0;
      if (name && qty>0){
        const p = products.find(pp=> String(pp.id)===String(pid) || pp.name===name) || {hasVat:false};
        items.push({ productId: p.id||'', productName: name, quantity: qty, price, total: qty*price, hasVat: !!p.hasVat });
      }
    });
    if (!items.length){ unlock(btn); return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); }
    sellTransactions.push({ id: String(Date.now()), date, customer, items, total: items.reduce((s,i)=>s+i.total,0) });
    saveAll();
    const ok = await syncNow('sell-submit');
    unlock(btn);
    if (ok){ alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); this.reset(); document.getElementById('sellDate').value=todayISO(); document.getElementById('sellItems').innerHTML=''; makeRow('sellItems','sell'); }
  });

  /* ====== Summary ====== */
  function buildMonthData(month){
    const inMonth = (d)=> String(d||'').slice(0,7)===month;
    const buysM = buyTransactions.filter(t=> inMonth(t.date)); 
    const sellsM = sellTransactions.filter(t=> inMonth(t.date));
    const allItems = [...buysM.flatMap(t=>t.items), ...sellsM.flatMap(t=>t.items)];
    const vatItems = allItems.filter(i=>i.hasVat);
    const noVatItems = allItems.filter(i=>!i.hasVat);
    const vatSubtotal = vatItems.reduce((s,i)=>s+i.total,0);
    const vatAmount = vatSubtotal*0.07;
    const vatTotal = vatSubtotal+vatAmount;
    const noVatTotal = noVatItems.reduce((s,i)=>s+i.total,0);
    const totalBuy = buysM.reduce((s,t)=>s+t.total,0);
    const totalSell = sellsM.reduce((s,t)=>s+t.total,0);
    return { vatItems, noVatItems, vatSubtotal, vatAmount, vatTotal, noVatTotal, totalBuy, totalSell, profit: totalSell-totalBuy };
  }
  function refreshSummary(){
    const m = document.getElementById('sumMonth').value || new Date().toISOString().slice(0,7);
    const d = buildMonthData(m);
    document.getElementById('sumTotalBuy').textContent = thb(d.totalBuy);
    document.getElementById('sumTotalSell').textContent = thb(d.totalSell);
    document.getElementById('sumTotalVat').textContent = thb(d.vatAmount);
    document.getElementById('sumProfit').textContent = thb(d.profit);
    document.getElementById('vatItemsCount').textContent = d.vatItems.length;
    document.getElementById('vatSubtotal').textContent = thb(d.vatSubtotal);
    document.getElementById('vatAmount').textContent = thb(d.vatAmount);
    document.getElementById('vatTotal').textContent = thb(d.vatTotal);
    document.getElementById('noVatItemsCount').textContent = d.noVatItems.length;
    document.getElementById('noVatTotal').textContent = thb(d.noVatTotal);
    const vatT = document.getElementById('vatItemsList');
    vatT.innerHTML = d.vatItems.length ? d.vatItems.map(i=>`<tr class="border-b border-gray-800"><td class="py-1">${i.productName}</td><td>${i.quantity}</td><td>${thb(i.price)}</td><td>${thb(i.total)}</td></tr>`).join('') : '<tr><td colspan="4" class="text-center py-3 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
    const noVatT = document.getElementById('noVatItemsList');
    noVatT.innerHTML = d.noVatItems.length ? d.noVatItems.map(i=>`<tr class="border-b border-gray-800"><td class="py-1">${i.productName}</td><td>${i.quantity}</td><td>${thb(i.price)}</td><td>${thb(i.total)}</td></tr>`).join('') : '<tr><td colspan="4" class="text-center py-3 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
  }
  document.getElementById('refreshSummary').onclick = refreshSummary;

  /* ====== Reports / Sheets Buttons ====== */
  document.getElementById('generatePDFBtn').onclick = async ()=>{
    const url=getScriptUrl(); if(!url) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Script URL'); rememberScriptUrl();
    const month=document.getElementById('reportMonth').value || new Date().toISOString().slice(0,7);
    setSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF 3 ‡∏´‡∏ô‡πâ‡∏≤...','text-yellow-400');
    try{
      const r=await fetch(`${url}?action=pdf&month=${encodeURIComponent(month)}`); const t=await r.text(); let d; try{d=JSON.parse(t);}catch(_){d={ok:false,error:t};}
      if (d.ok && d.url){ window.open(d.url,'_blank'); setSyncStatus('‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','text-emerald-400'); }
      else setSyncStatus('‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(d.error||'unknown'),'text-rose-400');
    }catch(e){ setSyncStatus('‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e,'text-rose-400');}
  };

  document.getElementById('exportCustomPdf').onclick = async ()=>{
    const url=getScriptUrl(); if(!url) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Script URL'); rememberScriptUrl();
    const month=document.getElementById('reportMonth').value || new Date().toISOString().slice(0,7);
    const mode=document.getElementById('pdfMode').value;
    const filter=document.getElementById('pdfFilter').value;
    const actor=document.getElementById('pdfActor').value || '__ALL__';
    setSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...','text-yellow-400');
    try{
      const r=await fetch(`${url}?action=pdf_custom&month=${encodeURIComponent(month)}&mode=${encodeURIComponent(mode)}&filter=${encodeURIComponent(filter)}&actor=${encodeURIComponent(actor)}`);
      const t=await r.text(); let d; try{d=JSON.parse(t);}catch(_){d={ok:false,error:t};}
      if (d.ok && d.url){ window.open(d.url,'_blank'); setSyncStatus('‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','text-emerald-400'); }
      else setSyncStatus('‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(d.error||'unknown'),'text-rose-400');
    }catch(e){ setSyncStatus('‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e,'text-rose-400');}
  };

  document.getElementById('syncToSheetsBtn').onclick = async ()=>{ await syncNow('manual'); };
  document.getElementById('btnSetup').onclick = async ()=>{
    const url=getScriptUrl(); if(!url) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Script URL'); rememberScriptUrl();
    try{
      const r=await fetch(`${url}?action=setup`); const t=await r.text(); let d; try{d=JSON.parse(t);}catch(_){d={ok:false,error:t};}
      alert(d.ok?'Setup ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à':'Setup ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+(d.error||'unknown'));
    }catch(e){ alert('Setup ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+e); }
  };

  // Export/Import
  function downloadBlob(filename, mime, text){
    const blob=new Blob([text],{type:mime}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},800);
  }
  document.getElementById('exportJsonBtn').onclick = async ()=>{
    const url=getScriptUrl(); if(!url){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Script URL');return;}
    setSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å JSON...','text-yellow-400');
    const r=await fetch(`${url}?action=export&format=json`); const t=await r.text();
    downloadBlob(`pos_snapshot_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`,'application/json;charset=utf-8',t);
    setSyncStatus('Export JSON ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','text-emerald-400');
  };
  document.getElementById('exportCsvBtn').onclick = async ()=>{
    const url=getScriptUrl(); if(!url){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Script URL');return;}
    const type=document.getElementById('exportCsvType').value;
    setSyncStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV (${type})...`,'text-yellow-400');
    const r=await fetch(`${url}?action=export&format=csv&type=${encodeURIComponent(type)}`); const t=await r.text();
    downloadBlob(`${type}_${new Date().toISOString().slice(0,10)}.csv`,'text/csv;charset=utf-8',t);
    setSyncStatus('Export CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','text-emerald-400');
  };
  async function doImportJson(mode){
    const url=getScriptUrl(); if(!url){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Script URL');return;}
    const input=document.getElementById('importJsonFile');
    input.onchange = async ()=>{
      const file=input.files[0]; if(!file) return;
      try{
        const text=await file.text(); const data=JSON.parse(text);
        ['products','stores','customers','categories','buyTransactions','sellTransactions'].forEach(k=>{ if(!data[k]) data[k]=[]; });
        setSyncStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (${mode})...`,'text-yellow-400');
        const r=await fetch(`${url}?action=import&mode=${encodeURIComponent(mode)}`,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(data)});
        const t=await r.text(); let d; try{d=JSON.parse(t);}catch(_){d={ok:false,error:t};}
        if (d.ok){
          // reload snapshot
          const r2=await fetch(`${url}?action=load`); const t2=await r2.text(); let d2; try{d2=JSON.parse(t2);}catch(_){d2={ok:false,error:t2};}
          if (d2.ok){
            products=d2.products||[]; stores=d2.stores||[]; customers=d2.customers||[]; categories=d2.categories||[];
            buyTransactions=d2.buyTransactions||[]; sellTransactions=d2.sellTransactions||[];
            saveAll(); initUI();
          }
          setSyncStatus('Import ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','text-emerald-400'); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }else{ setSyncStatus('Import ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+(d.error||'unknown'),'text-rose-400'); alert('Import ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+(d.error||'unknown')); }
      }catch(e){ setSyncStatus('Import ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+e,'text-rose-400'); alert('Import ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+e); }
      finally{ input.value=''; }
    };
    input.click();
  }
  document.getElementById('importMergeBtn').onclick = ()=> doImportJson('merge');
  document.getElementById('importReplaceBtn').onclick = ()=> { if(confirm('REPLACE ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏™‡πà‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡πÑ‡∏´‡∏°?')) doImportJson('replace'); };

  /* ====== Add/Delete Products ====== */
  document.getElementById('addProductBtn').onclick = ()=> document.getElementById('productForm').classList.remove('hidden');
  document.getElementById('cancelProductBtn').onclick = ()=> document.getElementById('productForm').classList.add('hidden');
  document.getElementById('addProductForm').onsubmit = (e)=>{
    e.preventDefault();
    const p = {
      id: Date.now().toString(),
      name: document.getElementById('productName').value.trim(),
      category: document.getElementById('productCategory').value.trim(),
      buyPrice: Number(document.getElementById('productBuyPrice').value)||0,
      sellPrice: Number(document.getElementById('productSellPrice').value)||0,
      hasVat: document.getElementById('productHasVat').checked
    };
    products.push(p); saveAll(); refreshProductsTable(); rebuildDatalist();
    document.getElementById('productForm').classList.add('hidden'); e.target.reset();
  };
  window.deleteProduct = (id)=>{
    if (!confirm('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?')) return;
    products = products.filter(p=> String(p.id)!==String(id));
    saveAll(); refreshProductsTable(); rebuildDatalist();
  };

  /* ====== Add Store / Customer / Category ====== */
  document.getElementById('addStoreBtn').onclick = ()=>{ const n=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô:'); if(n && !stores.includes(n)){ stores.push(n); saveAll(); refreshStores(); } };
  document.getElementById('addCustomerBtn').onclick = ()=>{ const n=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:'); if(n && !customers.includes(n)){ customers.push(n); saveAll(); refreshCustomers(); } };
  document.getElementById('addCategoryBtn').onclick = ()=>{ const n=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:'); if(n && !categories.includes(n)){ categories.push(n); saveAll(); refreshCategories(); } };

  /* ====== INIT ====== */
  function initUI(){
    document.getElementById('buyDate').value = todayISO();
    document.getElementById('sellDate').value = todayISO();
    const now=new Date(); document.getElementById('reportMonth').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    refreshStores(); refreshCustomers(); refreshCategories(); refreshProductsTable(); rebuildDatalist();
    document.getElementById('buyItems').innerHTML=''; document.getElementById('sellItems').innerHTML='';
    makeRow('buyItems','buy'); makeRow('sellItems','sell');
  }

  document.getElementById('loadFromSheetsBtn').onclick = async ()=>{
    const url=getScriptUrl(); if(!url) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Script URL'); rememberScriptUrl();
    setSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï...','text-yellow-400');
    try{
      const r=await fetch(`${url}?action=load`); const t=await r.text(); let d; try{d=JSON.parse(t);}catch(_){d={ok:false,error:t};}
      if (d.ok){
        products=d.products||[]; stores=d.stores||[]; customers=d.customers||[]; categories=d.categories||[];
        buyTransactions=d.buyTransactions||[]; sellTransactions=d.sellTransactions||[];
        saveAll(); initUI(); setSyncStatus('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','text-emerald-400');
      }else setSyncStatus('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(d.error||'unknown'),'text-rose-400');
    }catch(e){ setSyncStatus('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e,'text-rose-400');}
  };

  hookRowEvents();
  initUI();
  </script>
</body>
</html>