<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Plug2Plug POS ‚Äî ‡∏ã‡∏∑‡πâ‡∏≠/‡∏Ç‡∏≤‡∏¢ + ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á + PDF</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:'Sarabun',sans-serif;background:linear-gradient(135deg,#1e1b4b 0%,#7c2d12 25%,#1e40af 50%,#991b1b 75%,#1e1b4b 100%);background-size:400% 400%;animation:grad 15s ease infinite}
  @keyframes grad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .tab-content{display:none}.tab-content.active{display:block}
  .glass{background:rgba(255,255,255,.08);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.18)}
  .dark-glass{background:rgba(0,0,0,.3);backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.1)}
  .badge{padding:.15rem .5rem;border-radius:.75rem;font-size:.75rem;border:1px solid}
  .input-error{outline:2px solid #ef4444;border-color:#ef4444!important}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
</style>
</head>
<body class="min-h-screen text-white">
<div class="container mx-auto px-4 py-8 max-w-7xl">
  <div class="text-center mb-8">
    <h1 class="text-5xl font-bold mb-2">üè™ Plug2Plug POS</h1>
    <p class="text-gray-200">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Ä¢ ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥ ‚Ä¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡πÑ‡∏î‡πâ ‚Ä¢ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á ‚Ä¢ PDF ‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
  </div>

  <div class="dark-glass rounded-xl shadow-2xl mb-6">
    <div class="flex flex-wrap border-b border-gray-600">
      <button class="tab-btn px-6 py-4 font-medium text-blue-400 border-b-2 border-blue-400" data-tab="buy">üõí ‡∏ã‡∏∑‡πâ‡∏≠</button>
      <button class="tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white" data-tab="sell">üí∞ ‡∏Ç‡∏≤‡∏¢</button>
      <button class="tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white" data-tab="products">üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      <button class="tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white" data-tab="summary">üìä ‡∏™‡∏£‡∏∏‡∏õ</button>
      <button class="tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white" data-tab="reports">üìÑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
    </div>
    <div class="p-4 flex flex-col md:flex-row gap-3 items-start md:items-center">
      <div class="flex-1 w-full">
        <label class="block text-sm text-gray-300 mb-1">Google Apps Script URL (/exec)</label>
        <input id="scriptUrl" type="url" placeholder="https://script.google.com/macros/s/XXXX/exec" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg">
      </div>
      <div class="flex gap-2">
        <button id="setupSheetsBtn" class="btn px-3 py-2 bg-slate-700 rounded-lg">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        <button id="loadFromSheetsBtn" class="btn px-3 py-2 bg-purple-600 rounded-lg">üì• ‡πÇ‡∏´‡∏•‡∏î</button>
        <button id="syncToSheetsBtn" class="btn px-3 py-2 bg-indigo-600 rounded-lg">üìä ‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏µ‡∏ï</button>
      </div>
      <div id="syncStatus" class="text-sm text-gray-300">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
    </div>
  </div>

  <!-- ===== BUY ===== -->
  <div id="buy" class="tab-content active">
    <div class="dark-glass rounded-xl p-6">
      <h2 class="text-2xl font-bold mb-6">üõí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ <span id="buyEditTag" class="hidden text-yellow-300 text-sm font-normal">‚Äî ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span></h2>
      <form id="buyForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div><label class="block text-sm mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="buyDate" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required></div>
          <div>
            <label class="block text-sm mb-1">‡∏£‡πâ‡∏≤‡∏ô</label>
            <div class="flex gap-2">
              <select id="buyStore" class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô</option></select>
              <button type="button" id="addStoreBtn" class="btn px-4 py-2 bg-emerald-600 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô</button>
            </div>
          </div>
        </div>

        <div class="border-t border-gray-600 pt-6">
          <div id="buyItems"></div>
          <button type="button" id="addBuyItem" class="btn mb-4 px-4 py-2 bg-blue-600 rounded-lg">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>

        <div class="flex gap-2 justify-end">
          <button type="button" id="cancelBuyEditBtn" class="btn px-4 py-2 bg-gray-700 rounded-lg hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button type="submit" id="buySubmitBtn" class="btn px-8 py-3 bg-black rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== SELL ===== -->
  <div id="sell" class="tab-content">
    <div class="dark-glass rounded-xl p-6">
      <h2 class="text-2xl font-bold mb-6">üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ <span id="sellEditTag" class="hidden text-yellow-300 text-sm font-normal">‚Äî ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span></h2>
      <form id="sellForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div><label class="block text-sm mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="sellDate" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required></div>
          <div>
            <label class="block text-sm mb-1">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
            <div class="flex gap-2">
              <select id="sellCustomer" class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option></select>
              <button type="button" id="addCustomerBtn" class="btn px-4 py-2 bg-emerald-600 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
            </div>
          </div>
        </div>

        <div class="border-t border-gray-600 pt-6">
          <div id="sellItems"></div>
          <button type="button" id="addSellItem" class="btn mb-4 px-4 py-2 bg-blue-600 rounded-lg">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>

        <div class="flex gap-2 justify-end">
          <button type="button" id="cancelSellEditBtn" class="btn px-4 py-2 bg-gray-700 rounded-lg hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button type="submit" id="sellSubmitBtn" class="btn px-8 py-3 bg-black rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== PRODUCTS ===== -->
  <div id="products" class="tab-content">
    <div class="dark-glass rounded-xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
        <button id="addProductBtn" class="btn px-4 py-2 bg-blue-600 rounded-lg">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </div>
      <div id="productForm" class="hidden mb-6 p-4 dark-glass rounded-lg">
        <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
        <form id="addProductForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div><label class="block text-sm mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input id="productName" type="text" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required></div>
          <div>
            <label class="block text-sm mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
            <div class="flex gap-2">
              <select id="productCategory" class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required>
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                <option>‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option><option>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option><option>‡∏Ç‡∏ô‡∏°</option><option>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
              </select>
              <button type="button" id="addCategoryBtn" class="btn px-4 py-2 bg-purple-600 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î</button>
            </div>
          </div>
          <div><label class="block text-sm mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ø)</label><input id="productBuyPrice" type="number" step="0.01" min="0" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required></div>
          <div><label class="block text-sm mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ø)</label><input id="productSellPrice" type="number" step="0.01" min="0" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" required></div>
          <div class="flex items-center"><input id="productHasVat" type="checkbox" class="mr-2"><label for="productHasVat" class="text-sm">‡∏°‡∏µ VAT 7%</label></div>
          <div class="flex gap-2"><button type="submit" class="btn px-4 py-2 bg-emerald-600 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button type="button" id="cancelProductBtn" class="btn px-4 py-2 bg-gray-700 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>
        </form>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead><tr class="border-b border-gray-600"><th class="text-left py-3 px-4">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="text-left py-3 px-4">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th class="text-left py-3 px-4">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠</th><th class="text-left py-3 px-4">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th><th class="text-left py-3 px-4">VAT</th><th class="text-left py-3 px-4">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° VAT</th><th class="text-left py-3 px-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
          <tbody id="productsTable"><tr><td colspan="7" class="text-center py-8 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== SUMMARY (Advanced) ===== -->
  <div id="summary" class="tab-content">
    <div class="dark-glass rounded-xl p-6 space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <div class="glass p-4 rounded">
          <label class="block text-sm mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
          <input type="month" id="sumMonth" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg">
        </div>
        <div class="glass p-4 rounded">
          <label class="block text-sm mb-1">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</label>
          <select id="sumMode" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg">
            <option value="buy">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠</option>
            <option value="sell">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</option>
          </select>
        </div>
        <div class="glass p-4 rounded">
          <div class="text-sm text-gray-300">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°</div>
          <div id="sumQty" class="text-2xl font-bold text-blue-400">0</div>
        </div>
        <div class="glass p-4 rounded">
          <div class="text-sm text-gray-300">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</div>
          <div id="sumAmount" class="text-2xl font-bold text-green-400">‡∏ø0</div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="glass p-4 rounded lg:col-span-2">
          <h3 class="text-lg font-semibold mb-3">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead><tr class="border-b border-gray-600"><th class="text-left py-2 px-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="text-left py-2 px-2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th class="text-right py-2 px-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°</th><th class="text-right py-2 px-2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th></tr></thead>
              <tbody id="sumByProduct"><tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr></tbody>
            </table>
          </div>
        </div>
        <div class="glass p-4 rounded">
          <h3 class="text-lg font-semibold mb-3">üè∑Ô∏è ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead><tr class="border-b border-gray-600"><th class="text-left py-2 px-2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th class="text-right py-2 px-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="text-right py-2 px-2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th></tr></thead>
              <tbody id="sumByCategory"><tr><td colspan="3" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="glass p-4 rounded">
        <h3 class="text-lg font-semibold mb-3" id="actorTitle">üè¨ ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô (‡∏ù‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠)</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead><tr class="border-b border-gray-600"><th class="text-left py-2 px-2" id="actorCol">‡∏£‡πâ‡∏≤‡∏ô</th><th class="text-right py-2 px-2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th></tr></thead>
            <tbody id="sumByActor"><tr><td colspan="2" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="glass p-4 rounded">
        <div class="flex flex-wrap gap-3 items-end">
          <div>
            <label class="block text-sm mb-1">‡∏ä‡∏ô‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
            <select id="pdfMode" class="px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg">
              <option value="buy">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</option>
              <option value="sell">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</label>
            <select id="pdfFilter" class="px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg">
              <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)</option>
              <option value="actor">‡∏ï‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>
              <option value="category">‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
              <option value="vat">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ VAT</option>
            </select>
          </div>
          <button id="exportCustomPdfBtn" class="btn px-4 py-2 bg-pink-600 rounded-lg">üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF ‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </div>
      </div>

      <div class="glass p-4 rounded">
        <h3 class="text-lg font-semibold mb-3">üïò ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div>
            <h4 class="font-semibold mb-2">‡∏ã‡∏∑‡πâ‡∏≠</h4>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead><tr class="border-b border-gray-600"><th class="text-left py-2 px-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="text-left py-2 px-2">‡∏£‡πâ‡∏≤‡∏ô</th><th class="text-right py-2 px-2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th class="text-left py-2 px-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="histBuy"><tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr></tbody>
              </table>
            </div>
          </div>
          <div>
            <h4 class="font-semibold mb-2">‡∏Ç‡∏≤‡∏¢</h4>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead><tr class="border-b border-gray-600"><th class="text-left py-2 px-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="text-left py-2 px-2">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th class="text-right py-2 px-2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th class="text-left py-2 px-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="histSell"><tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ===== REPORTS (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== -->
  <div id="reports" class="tab-content">
    <div class="dark-glass rounded-xl p-6 space-y-6">
      <div>
        <h2 class="text-2xl font-bold mb-6">üìÑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏≠‡∏ô‡∏à‡∏¥‡∏ô‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå)</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
          <div><label class="block text-sm mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input type="month" id="reportMonth" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg"></div>
          <div class="flex items-end gap-2">
            <button id="generatePDFBtn" class="btn px-6 py-2 bg-pink-600 rounded-lg">üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF 3 ‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏î‡∏¥‡∏°)</button>
            <span class="badge text-gray-300 border-gray-500">‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°</span>
          </div>
        </div>
      </div>
      <div>
        <h3 class="text-lg font-semibold mb-4">üìä ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠</h3>
        <div id="monthlyPreview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="glass p-4 rounded text-center"><div class="text-2xl font-bold text-blue-400" id="totalBuyAmount">‡∏ø0</div><div class="text-sm text-gray-300">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°</div></div>
          <div class="glass p-4 rounded text-center"><div class="text-2xl font-bold text-green-400" id="totalSellAmount">‡∏ø0</div><div class="text-sm text-gray-300">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div></div>
          <div class="glass p-4 rounded text-center"><div class="text-2xl font-bold text-red-400" id="totalVatAmount">‡∏ø0</div><div class="text-sm text-gray-300">VAT ‡∏£‡∏ß‡∏°</div></div>
          <div class="glass p-4 rounded text-center"><div class="text-2xl font-bold text-yellow-400" id="totalProfit">‡∏ø0</div><div class="text-sm text-gray-300">‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°</div></div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- typeahead shared list -->
<datalist id="productsDatalist"></datalist>

<script>
/* ===== State / Storage ===== */
let products = JSON.parse(localStorage.getItem('products')) || [];
let stores = JSON.parse(localStorage.getItem('stores')) || ['‡πÄ‡∏ã‡πÄ‡∏ß‡πà‡∏ô','‡πÇ‡∏•‡∏ï‡∏±‡∏™','‡∏ö‡∏¥‡πä‡∏Å‡∏ã‡∏µ','‡πÅ‡∏°‡πá‡∏Ñ‡πÇ‡∏Ñ‡∏£'];
let customers = JSON.parse(localStorage.getItem('customers')) || ['‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'];
let categories = JSON.parse(localStorage.getItem('categories')) || ['‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°','‡∏Ç‡∏ô‡∏°','‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ','‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];
let buyTransactions = JSON.parse(localStorage.getItem('buyTransactions')) || [];
let sellTransactions = JSON.parse(localStorage.getItem('sellTransactions')) || [];
function saveToStorage(){ localStorage.setItem('products',JSON.stringify(products)); localStorage.setItem('stores',JSON.stringify(stores)); localStorage.setItem('customers',JSON.stringify(customers)); localStorage.setItem('categories',JSON.stringify(categories)); localStorage.setItem('buyTransactions',JSON.stringify(buyTransactions)); localStorage.setItem('sellTransactions',JSON.stringify(sellTransactions)); }
function formatCurrency(n){ return new Intl.NumberFormat('th-TH',{style:'currency',currency:'THB'}).format(n||0); }
const uid=(p='')=>p+Math.random().toString(36).slice(2,8)+Date.now().toString(36);
const sid=v=>String(v??'');

/* ===== Tabs ===== */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const tab=btn.dataset.tab;
    document.querySelectorAll('.tab-btn').forEach(b=>b.className='tab-btn px-6 py-4 font-medium text-gray-300 hover:text-white');
    btn.className='tab-btn px-6 py-4 font-medium '+(tab==='reports'?'text-red-400 border-b-2 border-red-400':'text-blue-400 border-b-2 border-blue-400');
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    if(tab==='summary') refreshSummaryUI();
    if(tab==='reports'){ updateMonthlyPreview(); const now=new Date(); document.getElementById('reportMonth').value=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; }
  });
});

/* ===== Dropdowns / Lists ===== */
function updateStoreDropdowns(){ const s=document.getElementById('buyStore'); s.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô</option>'+stores.map(v=>`<option>${v}</option>`).join(''); }
function ensureDefaultCustomer(){ if(!customers.includes('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ')) customers=['‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',...customers]; }
function updateCustomerDropdowns(){ ensureDefaultCustomer(); const s=document.getElementById('sellCustomer'); const cur=s.value; s.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>'+customers.map(v=>`<option>${v}</option>`).join(''); s.value=cur||'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'; }
function updateCategoryDropdowns(){ const sel=document.getElementById('productCategory'); const cur=sel.value; sel.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>'+categories.map(v=>`<option>${v}</option>`).join(''); sel.value=cur; }
function updateProductsTable(){
  const tbody=document.getElementById('productsTable');
  if(!products.length){ tbody.innerHTML='<tr><td colspan="7" class="text-center py-8 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>'; return; }
  tbody.innerHTML=products.map(p=>{
    const vatPrice=p.hasVat?p.sellPrice*1.07:p.sellPrice;
    return `<tr class="border-b border-gray-600">
      <td class="py-3 px-4">${p.name}</td><td class="py-3 px-4">${p.category}</td>
      <td class="py-3 px-4">${formatCurrency(p.buyPrice)}</td>
      <td class="py-3 px-4">${formatCurrency(p.sellPrice)}</td>
      <td class="py-3 px-4"><span class="badge ${p.hasVat?'text-green-300 border-green-500 bg-green-600/20':'text-gray-300 border-gray-500 bg-gray-600/20'}">${p.hasVat?'‡∏°‡∏µ VAT':'‡πÑ‡∏°‡πà‡∏°‡∏µ VAT'}</span></td>
      <td class="py-3 px-4 font-semibold">${formatCurrency(vatPrice)}</td>
      <td class="py-3 px-4"><button onclick="deleteProduct('${sid(p.id)}')" class="text-red-400 hover:text-red-300 text-sm">üóëÔ∏è ‡∏•‡∏ö</button></td>
    </tr>`;
  }).join('');
}

/* ===== Typeahead (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤) ===== */
function updateProductDatalist(){
  const dl=document.getElementById('productsDatalist'); if(!dl) return;
  dl.innerHTML=products.map(p=>{
    const label=`${p.name}${p.category?` ‚Äî [${p.category}]`:''}${p.hasVat?' ‚Äî VAT':''}`;
    return `<option value="${p.name}">${label}</option>`;
  }).join('');
}
function findProductByTypedName(name){
  if(!name) return null; const q=name.trim().toLowerCase(); if(!q) return null;
  let hit=products.find(p=>String(p.name).toLowerCase()===q);
  if(hit) return hit;
  hit=products.find(p=>String(p.name).toLowerCase().startsWith(q));
  if(hit) return hit;
  hit=products.find(p=>String(p.name).toLowerCase().includes(q));
  return hit||null;
}
function attachProductInputHandlers(rowEl, mode){
  const input=rowEl.querySelector('.product-input');
  const hid=rowEl.querySelector('.product-id-hidden');
  const price=rowEl.querySelector('.price-input');

  const apply=(prod)=>{
    if(!prod){ hid.value=''; return; }
    hid.value=sid(prod.id);
    price.value = mode==='buy' ? (prod.buyPrice ?? '') : (prod.sellPrice ?? '');
  };

  // auto-select best match while typing (debounced)
  let t=null;
  input.addEventListener('input', ()=>{
    clearTimeout(t);
    t=setTimeout(()=>{
      const prod=findProductByTypedName(input.value);
      apply(prod);
    },120);
  });

  // Enter => lock to first match
  input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      const prod=findProductByTypedName(input.value);
      if(prod){ apply(prod); }
    }
  });

  input.addEventListener('blur', ()=>{
    if(hid.value) return;
    const prod=findProductByTypedName(input.value);
    apply(prod);
  });
}

/* ===== Rows (‡∏ã‡∏∑‡πâ‡∏≠/‡∏Ç‡∏≤‡∏¢) ===== */
function buyItemRow(){
  const d=document.createElement('div');
  d.className='buy-item grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 glass rounded-lg border border-gray-600';
  d.innerHTML=`
    <div>
      <label class="block text-sm mb-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <input class="product-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" list="productsDatalist" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‚Ä¶" required>
      <input type="hidden" class="product-id-hidden">
    </div>
    <div>
      <label class="block text-sm mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
      <input type="number" class="quantity-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" min="1" value="1" required>
    </div>
    <div>
      <label class="block text-sm mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)</label>
      <input type="number" class="price-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" step="0.01" min="0" required>
    </div>
    <div class="flex items-end">
      <button type="button" class="remove-item w-full px-3 py-2 bg-red-600 rounded-lg">‡∏•‡∏ö</button>
    </div>`;
  attachProductInputHandlers(d,'buy'); return d;
}
function sellItemRow(){
  const d=document.createElement('div');
  d.className='sell-item grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 glass rounded-lg border border-gray-600';
  d.innerHTML=`
    <div>
      <label class="block text-sm mb-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <input class="product-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" list="productsDatalist" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‚Ä¶" required>
      <input type="hidden" class="product-id-hidden">
    </div>
    <div>
      <label class="block text-sm mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
      <input type="number" class="quantity-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" min="1" value="1" required>
    </div>
    <div>
      <label class="block text-sm mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ø)</label>
      <input type="number" class="price-input w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg" step="0.01" min="0" required>
    </div>
    <div class="flex items-end">
      <button type="button" class="remove-item w-full px-3 py-2 bg-red-600 rounded-lg">‡∏•‡∏ö</button>
    </div>`;
  attachProductInputHandlers(d,'sell'); return d;
}
function addBuyItem(){ document.getElementById('buyItems').appendChild(buyItemRow()); updateProductDatalist(); }
function addSellItem(){ document.getElementById('sellItems').appendChild(sellItemRow()); updateProductDatalist(); }
document.getElementById('addBuyItem').addEventListener('click',addBuyItem);
document.getElementById('addSellItem').addEventListener('click',addSellItem);
document.addEventListener('click',e=>{
  if(e.target.classList.contains('remove-item')){
    const row=e.target.closest('.buy-item,.sell-item');
    const box=row.parentElement;
    if(box.children.length>1) row.remove(); else alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
  }
});

/* ===== Add master data ===== */
document.getElementById('addStoreBtn').addEventListener('click',()=>{ const n=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô:'); if(n && !stores.includes(n)){ stores.push(n); saveToStorage(); updateStoreDropdowns(); }});
document.getElementById('addCustomerBtn').addEventListener('click',()=>{ const n=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:'); if(n && !customers.includes(n)){ customers.push(n); saveToStorage(); updateCustomerDropdowns(); }});
document.getElementById('addCategoryBtn').addEventListener('click',()=>{ const n=prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:'); if(n && !categories.includes(n)){ categories.push(n); saveToStorage(); updateCategoryDropdowns(); }});
document.getElementById('addProductBtn').addEventListener('click',()=>document.getElementById('productForm').classList.remove('hidden'));
document.getElementById('cancelProductBtn').addEventListener('click',()=>{ document.getElementById('productForm').classList.add('hidden'); document.getElementById('addProductForm').reset(); });

/* ===== Add product ===== */
document.getElementById('addProductForm').addEventListener('submit',e=>{
  e.preventDefault();
  const product={ id:uid('p_'), name:productName.value, category:productCategory.value, buyPrice:parseFloat(productBuyPrice.value), sellPrice:parseFloat(productSellPrice.value), hasVat:productHasVat.checked };
  products.push(product); saveToStorage(); updateProductsTable(); updateProductDatalist();
  document.getElementById('productForm').classList.add('hidden'); e.target.reset();
  syncNow('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
});

/* ===== Anti double-submit ===== */
let submitLock=false, lastSubmitKey=null, lastSubmitTime=0;
function makeSubmitKey(obj){ try{ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))).slice(0,80); }catch(_){ return String(Date.now()); } }
function withSubmitLock(btn, fn){
  return async (...args)=>{
    if(submitLock) return;
    submitLock=true; const orig=btn.textContent; btn.setAttribute('disabled','disabled'); btn.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶';
    try{ await fn(...args); } finally { btn.removeAttribute('disabled'); btn.textContent=orig; submitLock=false; }
  };
}

/* ===== Validate lines ===== */
function validateLines(container){
  const rows=[...container.querySelectorAll('.buy-item,.sell-item')];
  if(!rows.length) return {ok:false,msg:'‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'};
  let ok=true,msg=null;
  rows.forEach(r=>{
    const name=r.querySelector('.product-input').value.trim();
    const pid=r.querySelector('.product-id-hidden').value;
    const q=Number(r.querySelector('.quantity-input').value);
    const p=Number(r.querySelector('.price-input').value);
    if(!pid && !findProductByTypedName(name)) { ok=false; msg='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'; }
    if(!(q>0)) { ok=false; msg='‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0'; }
    if(!(p>=0)) { ok=false; msg='‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; }
  });
  return {ok,msg};
}

/* ===== Submit BUY (create/edit) ===== */
let editingBuyId=null, editingSellId=null;
const buySubmitBtn=document.getElementById('buySubmitBtn');
document.getElementById('buyForm').addEventListener('submit', withSubmitLock(buySubmitBtn, async (e)=>{
  e.preventDefault?.();
  const cont=document.getElementById('buyItems'); const v=validateLines(cont); if(!v.ok) return alert(v.msg);
  const date=buyDate.value, store=buyStore.value; if(!store) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô');
  const items=[]; cont.querySelectorAll('.buy-item').forEach(row=>{
    const prod = products.find(p=>sid(p.id)===sid(row.querySelector('.product-id-hidden').value)) || findProductByTypedName(row.querySelector('.product-input').value);
    const q=Number(row.querySelector('.quantity-input').value); const p=Number(row.querySelector('.price-input').value);
    if(prod){ items.push({productId:sid(prod.id),productName:prod.name,quantity:q,price:p,total:q*p,hasVat:!!prod.hasVat}); }
  });
  const payload={type:'buy',date,store,items};
  const key=makeSubmitKey(payload); const now=Date.now();
  if(key===lastSubmitKey && (now-lastSubmitTime)<4000){ alert('‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß'); return; }
  lastSubmitKey=key; lastSubmitTime=now;

  if(editingBuyId){
    const idx=buyTransactions.findIndex(t=>t.id===editingBuyId);
    if(idx>-1) buyTransactions[idx]={ id:editingBuyId, date, store, items, total:items.reduce((s,i)=>s+i.total,0) };
  }else{
    const id=uid('buy_'); buyTransactions.push({ id, date, store, items, total:items.reduce((s,i)=>s+i.total,0) });
  }
  saveToStorage(); await syncNow(editingBuyId?'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ã‡∏∑‡πâ‡∏≠':'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠');
  alert(editingBuyId?'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!':'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
  // reset
  editingBuyId=null; document.getElementById('buyEditTag').classList.add('hidden'); document.getElementById('cancelBuyEditBtn').classList.add('hidden');
  document.getElementById('buyForm').reset(); buyDate.value=new Date().toISOString().split('T')[0];
  cont.innerHTML=''; addBuyItem(); updateProductDatalist(); refreshSummaryUI();
}));

/* ===== Submit SELL (create/edit) ===== */
const sellSubmitBtn=document.getElementById('sellSubmitBtn');
document.getElementById('sellForm').addEventListener('submit', withSubmitLock(sellSubmitBtn, async (e)=>{
  e.preventDefault?.();
  const cont=document.getElementById('sellItems'); const v=validateLines(cont); if(!v.ok) return alert(v.msg);
  const date=sellDate.value, customer=sellCustomer.value||'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
  const items=[]; cont.querySelectorAll('.sell-item').forEach(row=>{
    const prod = products.find(p=>sid(p.id)===sid(row.querySelector('.product-id-hidden').value)) || findProductByTypedName(row.querySelector('.product-input').value);
    const q=Number(row.querySelector('.quantity-input').value); const p=Number(row.querySelector('.price-input').value);
    if(prod){ items.push({productId:sid(prod.id),productName:prod.name,quantity:q,price:p,total:q*p,hasVat:!!prod.hasVat}); }
  });
  const payload={type:'sell',date,customer,items};
  const key=makeSubmitKey(payload); const now=Date.now();
  if(key===lastSubmitKey && (now-lastSubmitTime)<4000){ alert('‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß'); return; }
  lastSubmitKey=key; lastSubmitTime=now;

  if(editingSellId){
    const idx=sellTransactions.findIndex(t=>t.id===editingSellId);
    if(idx>-1) sellTransactions[idx]={ id:editingSellId, date, customer, items, total:items.reduce((s,i)=>s+i.total,0) };
  }else{
    const id=uid('sell_'); sellTransactions.push({ id, date, customer, items, total:items.reduce((s,i)=>s+i.total,0) });
  }
  saveToStorage(); await syncNow(editingSellId?'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡∏≤‡∏¢':'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≤‡∏¢');
  alert(editingSellId?'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!':'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
  // reset
  editingSellId=null; document.getElementById('sellEditTag').classList.add('hidden'); document.getElementById('cancelSellEditBtn').classList.add('hidden');
  document.getElementById('sellForm').reset(); sellDate.value=new Date().toISOString().split('T')[0];
  cont.innerHTML=''; addSellItem(); updateProductDatalist(); refreshSummaryUI();
}));

/* ===== Edit/Delete transactions ===== */
window.editBuy=(id)=>{
  const t=buyTransactions.find(x=>x.id===id); if(!t) return;
  document.querySelector('[data-tab="buy"]').click();
  buyDate.value=t.date; buyStore.value=t.store;
  const box=document.getElementById('buyItems'); box.innerHTML='';
  t.items.forEach(it=>{ const r=buyItemRow(); r.querySelector('.product-input').value=it.productName; r.querySelector('.product-id-hidden').value=it.productId; r.querySelector('.quantity-input').value=it.quantity; r.querySelector('.price-input').value=it.price; box.appendChild(r); });
  editingBuyId=id; document.getElementById('buyEditTag').classList.remove('hidden'); document.getElementById('cancelBuyEditBtn').classList.remove('hidden');
};
window.deleteBuy=async(id)=>{
  if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ?')) return;
  buyTransactions=buyTransactions.filter(x=>x.id!==id); saveToStorage(); await syncNow('‡∏•‡∏ö‡∏ã‡∏∑‡πâ‡∏≠'); refreshSummaryUI();
};
document.getElementById('cancelBuyEditBtn').addEventListener('click',()=>{
  editingBuyId=null; document.getElementById('buyEditTag').classList.add('hidden'); document.getElementById('cancelBuyEditBtn').classList.add('hidden');
  document.getElementById('buyForm').reset(); buyDate.value=new Date().toISOString().split('T')[0];
  const box=document.getElementById('buyItems'); box.innerHTML=''; addBuyItem();
});

window.editSell=(id)=>{
  const t=sellTransactions.find(x=>x.id===id); if(!t) return;
  document.querySelector('[data-tab="sell"]').click();
  sellDate.value=t.date; sellCustomer.value=t.customer;
  const box=document.getElementById('sellItems'); box.innerHTML='';
  t.items.forEach(it=>{ const r=sellItemRow(); r.querySelector('.product-input').value=it.productName; r.querySelector('.product-id-hidden').value=it.productId; r.querySelector('.quantity-input').value=it.quantity; r.querySelector('.price-input').value=it.price; box.appendChild(r); });
  editingSellId=id; document.getElementById('sellEditTag').classList.remove('hidden'); document.getElementById('cancelSellEditBtn').classList.remove('hidden');
};
window.deleteSell=async(id)=>{
  if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ô‡∏µ‡πâ?')) return;
  sellTransactions=sellTransactions.filter(x=>x.id!==id); saveToStorage(); await syncNow('‡∏•‡∏ö‡∏Ç‡∏≤‡∏¢'); refreshSummaryUI();
};
document.getElementById('cancelSellEditBtn').addEventListener('click',()=>{
  editingSellId=null; document.getElementById('sellEditTag').classList.add('hidden'); document.getElementById('cancelSellEditBtn').classList.add('hidden');
  document.getElementById('sellForm').reset(); sellDate.value=new Date().toISOString().split('T')[0];
  const box=document.getElementById('sellItems'); box.innerHTML=''; addSellItem();
});

/* ===== Summary compute ===== */
function monthMatches(dateStr, yyyyMM){
  if(!dateStr) return false; return String(dateStr).slice(0,7)===yyyyMM;
}
function aggForMonth(mode, yyyyMM){
  const trans=(mode==='buy'?buyTransactions:sellTransactions).filter(t=>monthMatches(t.date,yyyyMM));
  const items=[]; trans.forEach(t=>t.items.forEach(i=>items.push({...i, _actor: mode==='buy'? t.store : t.customer})));
  const byProduct = new Map();
  const byCategory = new Map();
  const byActor = new Map();
  let totalQty=0,totalAmt=0;
  items.forEach(i=>{
    totalQty+=i.quantity; totalAmt+=i.total;
    const keyP=i.productName;
    const keyC=(products.find(p=>sid(p.id)===sid(i.productId))?.category)||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    const keyA=i._actor|| (mode==='buy'?'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡πâ‡∏≤‡∏ô':'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
    // product
    if(!byProduct.has(keyP)) byProduct.set(keyP,{ productName:keyP, category:keyC, qty:0, amount:0 });
    const p=byProduct.get(keyP); p.qty+=i.quantity; p.amount+=i.total;
    // category
    if(!byCategory.has(keyC)) byCategory.set(keyC,{ category:keyC, qty:0, amount:0 });
    const c=byCategory.get(keyC); c.qty+=i.quantity; c.amount+=i.total;
    // actor
    if(!byActor.has(keyA)) byActor.set(keyA,{ actor:keyA, amount:0 });
    const a=byActor.get(keyA); a.amount+=i.total;
  });
  const arrP=[...byProduct.values()].sort((a,b)=>b.amount-a.amount);
  const arrC=[...byCategory.values()].sort((a,b)=>b.amount-a.amount);
  const arrA=[...byActor.values()].sort((a,b)=>b.amount-a.amount);
  return { trans, items, arrP, arrC, arrA, totalQty, totalAmt };
}

function refreshSummaryUI(){
  const now=new Date(); const mInp=document.getElementById('sumMonth');
  if(!mInp.value) mInp.value=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const yyyyMM=mInp.value; const mode=document.getElementById('sumMode').value;
  const {trans, arrP, arrC, arrA, totalQty, totalAmt}=aggForMonth(mode, yyyyMM);
  // cards
  document.getElementById('sumQty').textContent=totalQty.toLocaleString('th-TH');
  document.getElementById('sumAmount').textContent=formatCurrency(totalAmt);
  // product table
  const tp=document.getElementById('sumByProduct');
  tp.innerHTML = arrP.length? arrP.map(r=>`<tr class="border-b border-gray-600"><td class="py-2 px-2">${r.productName}</td><td class="py-2 px-2">${r.category}</td><td class="py-2 px-2 text-right">${r.qty.toLocaleString('th-TH')}</td><td class="py-2 px-2 text-right">${formatCurrency(r.amount)}</td></tr>`).join('') : '<tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
  // category table
  const tc=document.getElementById('sumByCategory');
  tc.innerHTML = arrC.length? arrC.map(r=>`<tr class="border-b border-gray-600"><td class="py-2 px-2">${r.category}</td><td class="py-2 px-2 text-right">${r.qty.toLocaleString('th-TH')}</td><td class="py-2 px-2 text-right">${formatCurrency(r.amount)}</td></tr>`).join('') : '<tr><td colspan="3" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
  // actor title/col
  document.getElementById('actorTitle').textContent = (mode==='buy')? 'üè¨ ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô (‡∏ù‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠)' : 'üßë‚Äçü§ù‚Äçüßë ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢)';
  document.getElementById('actorCol').textContent = (mode==='buy')? '‡∏£‡πâ‡∏≤‡∏ô' : '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
  const ta=document.getElementById('sumByActor');
  ta.innerHTML = arrA.length? arrA.map(r=>`<tr class="border-b border-gray-600"><td class="py-2 px-2">${r.actor}</td><td class="py-2 px-2 text-right">${formatCurrency(r.amount)}</td></tr>`).join('') : '<tr><td colspan="2" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
  // history
  const hb=document.getElementById('histBuy'); const hs=document.getElementById('histSell');
  const buys=buyTransactions.filter(t=>monthMatches(t.date,yyyyMM)); const sells=sellTransactions.filter(t=>monthMatches(t.date,yyyyMM));
  hb.innerHTML = buys.length? buys.map(t=>`<tr class="border-b border-gray-600"><td class="py-2 px-2">${t.date}</td><td class="py-2 px-2">${t.store}</td><td class="py-2 px-2 text-right">${formatCurrency(t.total)}</td><td class="py-2 px-2"><button class="text-amber-300 mr-2" onclick="editBuy('${t.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="text-red-400" onclick="deleteBuy('${t.id}')">‡∏•‡∏ö</button></td></tr>`).join('') : '<tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
  hs.innerHTML = sells.length? sells.map(t=>`<tr class="border-b border-gray-600"><td class="py-2 px-2">${t.date}</td><td class="py-2 px-2">${t.customer}</td><td class="py-2 px-2 text-right">${formatCurrency(t.total)}</td><td class="py-2 px-2"><button class="text-amber-300 mr-2" onclick="editSell('${t.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="text-red-400" onclick="deleteSell('${t.id}')">‡∏•‡∏ö</button></td></tr>`).join('') : '<tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
}
document.getElementById('sumMonth').addEventListener('change',refreshSummaryUI);
document.getElementById('sumMode').addEventListener('change',refreshSummaryUI);

/* ===== Custom PDF (‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ===== */
document.getElementById('exportCustomPdfBtn').addEventListener('click',()=>{
  const month=document.getElementById('sumMonth').value; if(!month) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
  const mode=document.getElementById('pdfMode').value; const filter=document.getElementById('pdfFilter').value;
  generateCustomPDF(month,mode,filter);
});
function generateCustomPDF(month, mode, filter){
  const { jsPDF }=window.jspdf; const doc=new jsPDF(); doc.setFont('helvetica');
  const title = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô${mode==='buy'?'‡∏ã‡∏∑‡πâ‡∏≠':'‡∏Ç‡∏≤‡∏¢'} ‚Äî ${month} (${filter})`;
  doc.setFontSize(16); doc.text(title, 14, 16);
  doc.setFontSize(11);
  const {arrP,arrC,arrA,totalQty,totalAmt,items}=aggForMonth(mode,month);

  const addTable=(head, body)=>{ doc.autoTable({ startY: doc.lastAutoTable? doc.lastAutoTable.finalY+8 : 22, head:[head], body }); };

  if(filter==='all'){
    addTable(['‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°'], arrP.map(r=>[r.productName,r.category, r.qty.toLocaleString('th-TH'), formatCurrency(r.amount)]));
  }else if(filter==='actor'){
    addTable([mode==='buy'?'‡∏£‡πâ‡∏≤‡∏ô':'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°'], arrA.map(r=>[r.actor, formatCurrency(r.amount)]));
  }else if(filter==='category'){
    addTable(['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°'], arrC.map(r=>[r.category, r.qty.toLocaleString('th-TH'), formatCurrency(r.amount)]));
  }else if(filter==='vat'){
    const vatItems=items.filter(i=>i.hasVat);
    const byP=new Map(); vatItems.forEach(i=>{ const k=i.productName; if(!byP.has(k)) byP.set(k,{name:k,cat:(products.find(p=>sid(p.id)===sid(i.productId))?.category)||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',qty:0,amt:0}); const x=byP.get(k); x.qty+=i.quantity; x.amt+=i.total; });
    const rows=[...byP.values()].sort((a,b)=>b.amt-a.amt).map(x=>[x.name,x.cat,x.qty.toLocaleString('th-TH'),formatCurrency(x.amt)]);
    addTable(['‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (VAT)','‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°'], rows);
  }

  doc.autoTable({ startY: doc.lastAutoTable? doc.lastAutoTable.finalY+8 : 22, head:[['‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°']], body:[[mode==='buy'?'‡∏ã‡∏∑‡πâ‡∏≠':'‡∏Ç‡∏≤‡∏¢', totalQty.toLocaleString('th-TH'), formatCurrency(totalAmt)]] });
  doc.save(`‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô_${mode==='buy'?'‡∏ã‡∏∑‡πâ‡∏≠':'‡∏Ç‡∏≤‡∏¢'}_${month}_${filter}.pdf`);
}

/* ===== Old monthly PDF (3 ‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏î‡∏¥‡∏°) ===== */
function getMonthlyData(month){
  const [Y,M]=month.split('-');
  const filt=t=>{ const d=new Date(t.date); return d.getFullYear()==Y && (d.getMonth()+1)==Number(M); };
  const mb=buyTransactions.filter(filt), ms=sellTransactions.filter(filt);
  const all=[]; mb.forEach(t=>all.push(...t.items)); ms.forEach(t=>all.push(...t.items));
  const vat=all.filter(i=>i.hasVat);
  const totalBuy=mb.reduce((s,t)=>s+t.total,0), totalSell=ms.reduce((s,t)=>s+t.total,0), totalVat=vat.reduce((s,i)=>s+i.total*0.07,0);
  return {buyTransactions:mb, sellTransactions:ms, vatItems:vat, totalBuy, totalSell, totalVat, profit: totalSell-totalBuy};
}
document.getElementById('generatePDFBtn').addEventListener('click', function(){
  const m=document.getElementById('reportMonth').value; if(!m) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô');
  const { jsPDF }=window.jspdf; const doc=new jsPDF(); doc.setFont('helvetica');
  doc.setFontSize(20); doc.text('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',105,18,{align:'center'}); doc.setFontSize(12); doc.text(`‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${m}`,105,26,{align:'center'});
  const md=getMonthlyData(m); let y=34;
  doc.setFontSize(14); doc.text('‡∏´‡∏ô‡πâ‡∏≤ 1: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠',14,y); y+=6;
  doc.autoTable({ startY:y, head:[['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏£‡πâ‡∏≤‡∏ô','‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°']], body: md.buyTransactions.map(t=>[t.date,t.store,t.items.map(i=>`${i.productName} (${i.quantity})`).join(', '),formatCurrency(t.total)]) });
  doc.addPage(); y=20; doc.setFontSize(14); doc.text('‡∏´‡∏ô‡πâ‡∏≤ 2: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢',14,y); y+=6;
  doc.autoTable({ startY:y, head:[['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤','‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°']], body: md.sellTransactions.map(t=>[t.date,t.customer,t.items.map(i=>`${i.productName} (${i.quantity})`).join(', '),formatCurrency(t.total)]) });
  doc.addPage(); y=20; doc.setFontSize(14); doc.text('‡∏´‡∏ô‡πâ‡∏≤ 3: ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î',14,y); y+=8;
  doc.setFontSize(12); doc.text(`‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏°: ${formatCurrency(md.totalBuy)}`,14,y); y+=6; doc.text(`‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ${formatCurrency(md.totalSell)}`,14,y); y+=6; doc.text(`VAT ‡∏£‡∏ß‡∏°: ${formatCurrency(md.totalVat)}`,14,y); y+=6; doc.text(`‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°: ${formatCurrency(md.profit)}`,14,y);
  doc.save(`‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô_${m.replace('-','_')}.pdf`);
});

/* ===== Network / Sync (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠) ===== */
const getScriptUrl=()=> (document.getElementById('scriptUrl')?.value || localStorage.getItem('scriptUrl') || '').trim();
const rememberScriptUrl=()=>{ const u=getScriptUrl(); if(u) localStorage.setItem('scriptUrl',u); };
function setSyncStatus(msg,color='text-gray-300'){ const el=document.getElementById('syncStatus'); if(el){ el.textContent=msg; el.className=`text-sm ${color}`; } }
function errorToString(err){ return (err?.name||'Error')+(err?.message?': '+err.message:''); }
async function httpJson(url, {method='GET', headers={}, body=null, timeoutMs=12000}={}, retries=1){
  for(let a=0;a<=retries;a++){
    const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const res=await fetch(url,{method,headers,body,signal:ctrl.signal});
      clearTimeout(t);
      const text=await res.text(); let data={}; try{ data=text?JSON.parse(text):{} }catch(_){}
      if(!res.ok) throw new Error((data&&data.error)||text||`HTTP ${res.status}`);
      return data;
    }catch(err){ clearTimeout(t); if(a===retries) throw err; await new Promise(r=>setTimeout(r,600*(a+1))); }
  }
}
async function postPlainJson(url,obj){ return httpJson(url,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(obj),timeoutMs:15000},2); }
async function ping(u){ return httpJson(u,{method:'GET',timeoutMs:6000},1); }
async function syncNow(reason='auto'){
  const u=getScriptUrl(); if(!u){ setSyncStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà URL','text-red-400'); return {ok:false}; }
  setSyncStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (${reason})...`,'text-yellow-400');
  const payload={ products, buyTransactions, sellTransactions, stores, customers, categories, timestamp:new Date().toISOString() };
  try{ await ping(u); const r=await postPlainJson(u,payload); if(r?.ok){ setSyncStatus(`‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${reason})`,'text-green-400'); return {ok:true}; } setSyncStatus(`‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${r?.error||'unknown'}`,'text-red-400'); }
  catch(e){ setSyncStatus('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+errorToString(e),'text-red-400'); }
  return {ok:false};
}
document.getElementById('setupSheetsBtn').addEventListener('click', async ()=>{
  try{ const u=getScriptUrl(); if(!u) return alert('‡πÉ‡∏™‡πà URL ‡∏Å‡πà‡∏≠‡∏ô'); rememberScriptUrl(); setSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤...','text-yellow-400'); const r=await httpJson(`${u}?action=setup`,{method:'GET',timeoutMs:12000},1); setSyncStatus(r?.ok?'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à!':'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', r?.ok?'text-green-400':'text-red-400'); }
  catch(e){ setSyncStatus('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+errorToString(e),'text-red-400'); }
});
document.getElementById('loadFromSheetsBtn').addEventListener('click', async ()=>{
  try{ const u=getScriptUrl(); if(!u) return alert('‡πÉ‡∏™‡πà URL ‡∏Å‡πà‡∏≠‡∏ô'); rememberScriptUrl(); setSyncStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...','text-yellow-400'); const d=await httpJson(`${u}?action=load`,{method:'GET',timeoutMs:15000},2);
    if(d.products) products=d.products; if(d.buyTransactions) buyTransactions=d.buyTransactions; if(d.sellTransactions) sellTransactions=d.sellTransactions; if(d.stores) stores=d.stores; if(d.customers) customers=d.customers; if(d.categories) categories=d.categories;
    saveToStorage(); init(); setSyncStatus('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!','text-green-400'); }
  catch(e){ setSyncStatus('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+errorToString(e),'text-red-400'); }
});
document.getElementById('syncToSheetsBtn').addEventListener('click',()=>{ rememberScriptUrl(); syncNow('‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); });

/* ===== Monthly preview (‡πÄ‡∏î‡∏¥‡∏°) ===== */
function updateMonthlyPreview(){
  const now=new Date(); const m=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const md=getMonthlyData(m);
  totalBuyAmount.textContent=formatCurrency(md.totalBuy); totalSellAmount.textContent=formatCurrency(md.totalSell); totalVatAmount.textContent=formatCurrency(md.totalVat); totalProfit.textContent=formatCurrency(md.profit);
}

/* ===== Init ===== */
function normalizeProducts(){ let changed=false; products=(products||[]).map(p=>{ if(!p.id){ p.id=uid('p_'); changed=true; } p.id=sid(p.id); return p; }); if(changed) saveToStorage(); }
function init(){
  const today=new Date().toISOString().split('T')[0]; buyDate.value=today; sellDate.value=today;
  const saved=localStorage.getItem('scriptUrl'); if(saved) document.getElementById('scriptUrl').value=saved;
  normalizeProducts(); updateStoreDropdowns(); updateCustomerDropdowns(); updateCategoryDropdowns(); updateProductsTable(); updateProductDatalist();
  document.getElementById('buyItems').innerHTML=''; addBuyItem();
  document.getElementById('sellItems').innerHTML=''; addSellItem();
  refreshSummaryUI();
}
init();
</script>
</body>
</html>
